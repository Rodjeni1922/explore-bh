<!DOCTYPE html>
<html lang="bs">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff7300">
    <link rel="manifest" href="manifest.json">
    <title>BiH Outdoor Guide</title>
    <link rel="icon" href="favicon.png" />
    <!-- MapLibre GL -->
    <link href="https://cdn.jsdelivr.net/npm/maplibre-gl@4.7.0/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/maplibre-gl@4.7.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <!-- Weather Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
    <style>
        /* ===== BASE STYLES WITH LIGHT/DARK MODE ===== */
        :root {
            /* Light mode colors */
            --accent: #ff7300;
            --accent-light: #ff8c33;
            --accent-dark: #e66900;
            --blue: #0066ff;
            --blue-light: #3385ff;
            --green: #00a86b;
            --green-light: #33b989;
            --red: #ff3b30;
            --red-light: #ff6259;
            --yellow: #ffd700;
            --yellow-light: #ffdf33;
            --purple: #9c27b0;
            --purple-light: #b052c2;
            /* Light mode theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-overlay: rgba(255, 255, 255, 0.9);
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-tertiary: #6c757d;
            --text-inverse: #ffffff;
            --border-color: #dee2e6;
            --border-light: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-heavy: rgba(0, 0, 0, 0.2);
            --overlay-bg: rgba(0, 0, 0, 0.5);
            --overlay-light: rgba(0, 0, 0, 0.3);
            --card-bg: #ffffff;
            --input-bg: #ffffff;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            /* Fonts */
            --font-primary: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            --font-heading: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* Difficulty colors */
            --difficulty-easy: #00a86b;
            --difficulty-medium: #ffd700;
            --difficulty-hard: #ff3b30;
            --difficulty-extreme: #9c27b0;
            /* Weather colors */
            --weather-sunny: #ffd700;
            --weather-cloudy: #6c757d;
            --weather-rainy: #0066ff;
            --weather-snow: #80d4ff;
            --weather-storm: #9c27b0;
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --bg-overlay: rgba(30, 30, 30, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-tertiary: #b0b0b0;
            --text-inverse: #121212;
            --border-color: #404040;
            --border-light: #333333;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --shadow-heavy: rgba(0, 0, 0, 0.5);
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --overlay-light: rgba(0, 0, 0, 0.5);
            --card-bg: #1e1e1e;
            --input-bg: #2d2d2d;
            --modal-overlay: rgba(0, 0, 0, 0.8);
            /* Adjust accent colors for dark mode */
            --accent: #ff8c33;
            --accent-light: #ffa766;
            --accent-dark: #ff7300;
            /* Adjust difficulty colors for dark mode */
            --difficulty-easy: #33b989;
            --difficulty-medium: #ffdf33;
            --difficulty-hard: #ff6259;
            --difficulty-extreme: #b052c2;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            margin: 0;
            padding: 0;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: var(--font-primary);
            overflow: hidden;
            touch-action: manipulation;
            background: var(--bg-primary);
            position: relative;
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* FRAME FOR THE ENTIRE APP */
        .app-frame {
            position: fixed;
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            pointer-events: none;
            z-index: 5000 !important;
            box-shadow: 0 0 20px var(--shadow-color);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        /* ===== LOADING SCREEN ===== */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            animation: fadeIn 0.3s ease;
            transition: background-color 0.3s, color 0.3s;
        }

            #loading.hidden {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.5s ease;
            }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,115,0,0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        #loadingText {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===== LANDING SCREEN ===== */
        #landing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(var(--overlay-bg), var(--overlay-bg)), url('bih3.jpg');
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            transition: opacity 0.5s ease;
        }

            #landing-overlay.hidden {
                opacity: 0;
                pointer-events: none;
            }

        .landing-content {
            width: 100%;
            max-width: 400px;
            text-align: center;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .landing-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

            .landing-logo img {
                width: 80%;
                height: 80%;
                object-fit: contain;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            }

        .landing-content h1 {
            font-size: 28px;
            margin: 0 0 15px 0;
            font-weight: 700;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
            color: white;
        }

        .landing-content p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
            opacity: 0.95;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            color: rgba(255, 255, 255, 0.95);
        }

        /* Theme toggle on landing */
        .theme-toggle-landing {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

            .theme-btn.active {
                background: rgba(255, 255, 255, 0.2);
            }

        /* Language select */
        .lang-select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 12px;
            background: rgba(255,255,255,0.15);
            color: white;
            font-size: 16px;
            font-weight: 500;
            backdrop-filter: blur(15px);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

            .lang-select:hover {
                background-color: rgba(255,255,255,0.2);
                border-color: rgba(255,255,255,0.6);
            }

            .lang-select option {
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 10px;
            }

        .landing-btn {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 600;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 8px 25px rgba(255,115,0,0.4);
            min-height: 44px;
            backdrop-filter: blur(10px);
        }

            .landing-btn:active {
                transform: scale(0.98);
                background: var(--accent-dark);
            }

        /* ===== MAP ===== */
        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            border-radius: 15px;
        }

        /* Map controls */
        .maplibregl-ctrl-group {
            background: var(--bg-overlay) !important;
            backdrop-filter: blur(20px) !important;
            border-radius: 12px !important;
            box-shadow: 0 4px 20px var(--shadow-color) !important;
            border: 1px solid var(--border-color) !important;
            transition: background-color 0.3s, border-color 0.3s;
        }

            .maplibregl-ctrl-group button {
                width: 30px !important;
                height: 30px !important;
                min-height: 30px !important;
                min-width: 30px !important;
                font-size: 16px !important;
                line-height: 28px !important;
                color: var(--text-primary) !important;
            }

                .maplibregl-ctrl-group button .maplibregl-ctrl-icon {
                    filter: none !important;
                }

        /* ===== TOP CONTROLS ===== */
        .top-controls {
            position: fixed;
            top: max(env(safe-area-inset-top), 15px);
            left: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 500px;
            margin: 0 auto;
        }

        .control-card {
            background: var(--bg-overlay) !important;
            backdrop-filter: blur(15px) saturate(180%);
            border-radius: 16px;
            padding: 8px;
            display: flex;
            gap: 8px;
            box-shadow: 0 8px 32px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .layer-btn, .prof-btn {
            flex: 1;
            padding: 10px 6px;
            border: none;
            border-radius: 12px;
            background: var(--bg-tertiary) !important;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            min-height: 38px;
            backdrop-filter: blur(10px);
            border: 1px solid transparent;
        }

            .layer-btn.active, .prof-btn.active {
                background: rgba(255, 115, 0, 0.9) !important;
                color: white;
                box-shadow: 0 4px 12px rgba(255,115,0,0.3);
                border-color: rgba(255, 115, 0, 0.5);
            }

            .layer-btn:active, .prof-btn:active {
                transform: scale(0.96);
            }

        /* Theme toggle in main app */
        #themeToggle {
            position: fixed;
            top: max(env(safe-area-inset-top),145px);
            right: 15px;
            z-index: 1001;
            background: var(--bg-overlay);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        /* ===== SIDEBAR ===== */
        #openSidebarBtn {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 900;
            background: rgba(255, 115, 0, 0.9) !important;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 25px var(--shadow-color);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            min-width: 44px;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s;
        }

            #openSidebarBtn:hover {
                background: rgba(255, 115, 0, 1) !important;
            }

        #sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 75vw;
            max-width: 300px;
            height: calc(100% - 20px);
            background: var(--bg-overlay) !important;
            backdrop-filter: blur(15px) saturate(180%);
            z-index: 2000;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 20px var(--shadow-color);
            border-right: 1px solid var(--border-color);
            border-radius: 15px 0 0 15px;
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s, background-color 0.3s;
        }

            #sidebar.open {
                transform: translateX(0);
                opacity: 1;
            }

        .sidebar-header {
            padding: max(env(safe-area-inset-top), 25px) 20px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary) !important;
            backdrop-filter: blur(10px);
            border-radius: 15px 0 0 0;
        }

            .sidebar-header h2 {
                margin: 0;
                font-size: 22px;
                color: var(--text-primary);
                font-weight: 600;
            }


        #closeSidebar {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            min-height: 44px;
            min-width: 44px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

            #closeSidebar:active {
                background-color: var(--bg-tertiary);
            }

        /* ===== IMPROVED CATEGORY BAR - MULTI-SELECT ===== */
        .category-bar {
            padding: 12px 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            overflow-y: auto;
            max-height: 140px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary) !important;
            backdrop-filter: blur(10px);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
            touch-action: auto;
            user-select: none;
        }

            .category-bar::-webkit-scrollbar {
                width: 4px;
            }

            .category-bar::-webkit-scrollbar-track {
                background: transparent;
            }

            .category-bar::-webkit-scrollbar-thumb {
                background: var(--accent);
                border-radius: 2px;
            }

        .category-btn {
            padding: 8px 12px;
            background: var(--bg-secondary) !important;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            min-height: 36px;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            gap: 5px;
        }

            .category-btn.active {
                background: rgba(255, 115, 0, 0.9) !important;
                color: white;
                border-color: rgba(255, 115, 0, 0.5);
                box-shadow: 0 4px 12px rgba(255,115,0,0.3);
            }

            .category-btn .checkmark {
                display: none;
                font-size: 12px;
            }

            .category-btn.active .checkmark {
                display: inline;
            }

        /* Category selection summary */
        .category-summary {
            padding: 8px 15px;
            font-size: 12px;
            color: var(--text-tertiary);
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .clear-categories {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 12px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
        }

            .clear-categories:active {
                background-color: var(--bg-secondary);
            }

        /* Location list with weather */
        .location-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--bg-secondary) !important;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
            backdrop-filter: blur(5px);
            transition: background-color 0.3s;
        }

            .location-list::-webkit-scrollbar {
                width: 4px;
            }

            .location-list::-webkit-scrollbar-track {
                background: transparent;
            }

            .location-list::-webkit-scrollbar-thumb {
                background: var(--accent);
                border-radius: 2px;
            }

        .location-item {
            padding: 15px;
            background: var(--bg-tertiary) !important;
            border-radius: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
            backdrop-filter: blur(10px);
        }

            .location-item:active {
                transform: scale(0.98);
                background: var(--bg-secondary) !important;
            }

        .location-info {
            flex: 1;
        }

        .location-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 16px;
        }

        .location-category {
            font-size: 12px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .location-access {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .location-difficulty {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
            margin-right: 5px;
        }

        .difficulty-easy {
            background: var(--difficulty-easy);
            color: white;
        }

        .difficulty-medium {
            background: var(--difficulty-medium);
            color: var(--text-primary);
        }

        .difficulty-hard {
            background: var(--difficulty-hard);
            color: white;
        }

        .difficulty-extreme {
            background: var(--difficulty-extreme);
            color: white;
        }

        .location-weather {
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 3px;
        }

        .weather-icon {
            font-size: 14px;
        }

        .location-action {
            background: rgba(255, 115, 0, 0.9) !important;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
            min-width: 44px;
            backdrop-filter: blur(5px);
            transition: transform 0.2s;
        }

            .location-action:active {
                transform: scale(0.95);
            }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            position: fixed;
            bottom: max(env(safe-area-inset-bottom), 10px);
            left: 10px;
            right: 10px;
            height: 65px;
            background: var(--bg-overlay) !important;
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 8px;
            border-radius: 20px;
            box-shadow: 0 -5px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            padding: 6px 10px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
            min-width: 55px;
            min-height: 40px;
            position: relative;
        }

            .nav-btn:active {
                background: var(--bg-tertiary);
                color: var(--accent);
            }

            .nav-btn.active {
                color: var(--accent);
            }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .nav-btn#navStart .nav-icon {
            color: var(--green);
        }

        .nav-btn#navStop .nav-icon {
            color: var(--red);
        }

        /* ===== ENLARGED ROUTE PANEL ===== */
        #routePanel {
            position: fixed;
            bottom: 90px;
            left: 10px;
            right: 10px;
            max-height: 60vh;
            background: var(--bg-overlay) !important;
            backdrop-filter: blur(25px) saturate(180%);
            border-radius: 16px;
            padding: 15px;
            z-index: 900;
            box-shadow: 0 -8px 30px var(--shadow-heavy);
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
        }

        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary) !important;
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

            .route-header h3 {
                margin: 0;
                color: var(--text-primary);
                font-size: 18px;
                font-weight: 600;
            }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            min-height: 44px;
            min-width: 44px;
            backdrop-filter: blur(5px);
            border-radius: 8px;
            transition: background-color 0.2s;
        }

            .close-btn:active {
                background-color: var(--bg-tertiary);
            }

        .route-info {
            background: var(--bg-tertiary) !important;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
        }

        .route-stat {
            text-align: center;
            flex: 1;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 5px;
        }

        .waypoint-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 10px;
            background: var(--bg-tertiary) !important;
            max-height: 250px;
        }

            .waypoint-list::-webkit-scrollbar {
                width: 4px;
            }

            .waypoint-list::-webkit-scrollbar-track {
                background: transparent;
            }

            .waypoint-list::-webkit-scrollbar-thumb {
                background: var(--accent);
                border-radius: 2px;
            }

        .waypoint-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--bg-secondary) !important;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
            transition: transform 0.2s;
        }

            .waypoint-item:active {
                transform: scale(0.98);
            }

        .waypoint-number {
            width: 28px;
            height: 28px;
            background: rgba(255, 115, 0, 0.9) !important;
            color: white;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 12px;
            backdrop-filter: blur(5px);
        }

        .waypoint-details {
            flex: 1;
        }

        .waypoint-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
            color: var(--text-primary);
        }

        .waypoint-access {
            font-size: 11px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .waypoint-remove {
            background: none;
            border: none;
            color: var(--red);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            min-height: 44px;
            min-width: 44px;
            backdrop-filter: blur(5px);
            border-radius: 8px;
            transition: background-color 0.2s;
        }

            .waypoint-remove:active {
                background-color: var(--bg-tertiary);
            }

        /* ===== ENLARGED NAVIGATION PANEL ===== */
        #navPanel {
            position: fixed;
            bottom: 90px;
            left: 10px;
            right: 10px;
            max-height: 55vh;
            background: var(--bg-overlay) !important;
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 16px;
            padding: 15px;
            z-index: 900;
            box-shadow: 0 -5px 15px var(--shadow-heavy);
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
        }

            #navPanel.collapsed {
                height: auto;
                max-height: 100px;
                overflow: hidden;
                padding: 10px;
            }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary) !important;
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

            .nav-header h3 {
                margin: 0;
                color: var(--text-primary);
                font-size: 18px;
                font-weight: 600;
            }

        .nav-controls {
            display: flex;
            gap: 8px;
        }

        .nav-control-btn {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-color);
            width: 36px;
            height: 36px;
            border-radius: 18px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            transition: all 0.2s;
            min-height: 44px;
            min-width: 44px;
            backdrop-filter: blur(5px);
        }

            .nav-control-btn:active {
                background: var(--bg-tertiary) !important;
                transform: scale(0.95);
            }

        /* Current step info - enlarged */
        .current-step {
            flex: 1;
            padding: 20px;
            background: rgba(255, 115, 0, 0.15) !important;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
            backdrop-filter: blur(5px);
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .step-distance {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .step-text {
            font-size: 18px;
            color: var(--text-primary);
            line-height: 1.4;
        }

        /* Enlarged step list */
        .step-list {
            flex: 1;
            overflow-y: auto;
            max-height: 200px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 10px;
            background: var(--bg-tertiary) !important;
        }

            .step-list::-webkit-scrollbar {
                width: 4px;
            }

            .step-list::-webkit-scrollbar-track {
                background: transparent;
            }

            .step-list::-webkit-scrollbar-thumb {
                background: var(--accent);
                border-radius: 2px;
            }

        .step-item {
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            min-height: 44px;
        }

            .step-item:last-child {
                border-bottom: none;
            }

        .step-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 115, 0, 0.2) !important;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 16px;
            font-weight: 600;
            margin-right: 12px;
            backdrop-filter: blur(5px);
        }

        .step-content {
            flex: 1;
        }

        .step-main {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 14px;
        }

        .step-dist {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ===== DETAILS MODAL ===== */
        #detailsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            backdrop-filter: blur(5px);
            z-index: 3000;
            display: none;
            align-items: flex-end;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .details-card {
            width: 100%;
            max-height: 85vh;
            background: var(--bg-overlay) !important;
            backdrop-filter: blur(25px) saturate(180%);
            border-radius: 30px 30px 0 0;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.3s;
            border: 1px solid var(--border-color);
        }

            .details-card::-webkit-scrollbar {
                width: 4px;
            }

            .details-card::-webkit-scrollbar-track {
                background: transparent;
            }

            .details-card::-webkit-scrollbar-thumb {
                background: var(--accent);
                border-radius: 2px;
            }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            background: var(--bg-tertiary) !important;
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
        }

        .details-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
            padding-right: 20px;
            line-height: 1.3;
        }

        .details-category {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255, 115, 0, 0.9) !important;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
            backdrop-filter: blur(5px);
        }

        .details-image {
            width: 100%;
            height: 200px;
            background: var(--bg-tertiary) !important;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .details-desc {
            font-size: 16px;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 25px;
            background: var(--bg-tertiary) !important;
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
        }

        .details-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .meta-item {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-color);
        }

        .meta-icon {
            font-size: 20px;
            color: var(--accent);
        }

        .meta-content {
            flex: 1;
        }

        .meta-label {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 2px;
        }

        .meta-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .access-info {
            background: var(--bg-tertiary) !important;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--yellow);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
        }

        .access-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .access-details {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .details-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 40px;
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
        }

            .action-btn:active {
                transform: scale(0.98);
            }

            .action-btn.primary {
                background: rgba(255, 115, 0, 0.9) !important;
                color: white;
            }

            .action-btn.secondary {
                background: var(--bg-tertiary) !important;
                color: var(--text-primary);
            }

            .action-btn.warning {
                background: rgba(255, 215, 0, 0.9) !important;
                color: var(--text-primary);
            }

        .close-modal {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary) !important;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            min-height: 44px;
            backdrop-filter: blur(5px);
            transition: background-color 0.2s;
        }

            .close-modal:active {
                background: var(--bg-secondary) !important;
            }

        /* ===== MARKERS ===== */
        .place-marker {
            position: relative;
            width: 32px;
            height: 32px;
        }

        .place-marker-inner {
            width: 24px;
            height: 24px;
            background: var(--accent);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 3px 10px rgba(255,115,0,0.3);
            cursor: pointer;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.2s;
        }

            .place-marker-inner:active {
                transform: translate(-50%, -50%) scale(1.2);
            }

        /* Difficulty markers */
        .marker-easy {
            background: var(--difficulty-easy) !important;
        }

        .marker-medium {
            background: var(--difficulty-medium) !important;
        }

        .marker-hard {
            background: var(--difficulty-hard) !important;
        }

        .marker-extreme {
            background: var(--difficulty-extreme) !important;
        }

        /* ===== MY LOCATION MARKER ===== */
        .my-location-marker {
            width: 32px;
            height: 32px;
            position: relative;
        }

        .my-location-marker-inner {
            width: 24px;
            height: 24px;
            background: var(--blue);
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,102,255,0.3);
            cursor: pointer;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.2s;
        }

            .my-location-marker-inner:active {
                transform: translate(-50%, -50%) scale(1.2);
            }

            .my-location-marker-inner::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 8px;
                height: 8px;
                background: white;
                border-radius: 50%;
            }

        /* ===== VOICE BUTTON ANIMATION ===== */
        @keyframes voicePulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 168, 107, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 168, 107, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 168, 107, 0);
            }
        }

        #voiceBtn.active {
            animation: voicePulse 2s infinite;
            background: rgba(0, 168, 107, 0.9) !important;
            color: white;
        }

        /* ===== UPDATED MAP POPUP STYLES ===== */
        .maplibregl-popup-content {
            background: var(--bg-overlay) !important;
            border-radius: 12px !important;
            padding: 15px !important;
            width: 280px !important;
            max-height: 350px !important;
            overflow-y: auto !important;
            font-size: 14px !important;
            box-shadow: 0 8px 25px var(--shadow-heavy) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .maplibregl-popup-tip {
            background: var(--bg-overlay) !important;
            border: 1px solid var(--border-color) !important;
        }

        .maplibregl-popup-content strong {
            color: var(--text-primary);
            font-size: 16px;
        }

        .maplibregl-popup-content small {
            color: var(--text-tertiary);
        }

        .maplibregl-popup-content a {
            display: block;
            margin: 5px 0;
            padding: 10px 15px;
            background-color: var(--bg-tertiary) !important;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-primary) !important;
            transition: all 0.2s;
            width: 100%;
            box-sizing: border-box;
            text-align: center;
            font-weight: 500;
            font-size: 14px;
        }

            .maplibregl-popup-content a:hover {
                background-color: var(--bg-secondary) !important;
                text-decoration: none !important;
                transform: translateY(-1px);
            }

            .maplibregl-popup-content a:active,
            .maplibregl-popup-content a:focus {
                outline: none !important;
                box-shadow: 0 0 0 2px rgba(255, 115, 0, 0.3) !important;
                transform: translateY(0);
            }

            .maplibregl-popup-content a::after {
                display: none !important;
            }

            .maplibregl-popup-content a.active {
                background-color: rgba(255, 115, 0, 0.9) !important;
                color: white !important;
                border-color: rgba(255, 115, 0, 0.5);
            }


        /* ===== OFFLINE MODE INDICATOR ===== */
        .offline-indicator {
            position: fixed;
            top: max(env(safe-area-inset-top),145px);
            left: 18px;
            z-index: 1001;
            background: var(--bg-overlay);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-primary);
            display: none;
            align-items: center;
            gap: 4px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }

            .offline-indicator.online {
                background: rgba(0, 168, 107, 0.9);
                color: white;
            }

            .offline-indicator.offline {
                background: rgba(255, 59, 48, 0.9);
                color: white;
            }

        /* ===== SHARE MODAL ===== */
        #shareModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            backdrop-filter: blur(5px);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .share-card {
            width: 100%;
            max-width: 400px;
            background: var(--bg-overlay);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px var(--shadow-heavy);
        }

        .share-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

            .share-header h3 {
                font-size: 20px;
                color: var(--text-primary);
                margin: 0;
            }

        .share-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

            .share-option:active {
                transform: scale(0.95);
            }

        .share-icon {
            font-size: 24px;
        }

        .share-label {
            font-size: 12px;
            color: var(--text-primary);
        }

        .share-url {
            margin-top: 15px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

            .share-url input {
                flex: 1;
                background: none;
                border: none;
                color: var(--text-primary);
                font-size: 14px;
                outline: none;
            }

        .copy-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ===== DOWNLOAD PANEL ===== */
        #downloadPanel {
            position: fixed;
            bottom: 90px;
            left: 10px;
            right: 10px;
            max-height: 50vh;
            background: var(--bg-overlay);
            backdrop-filter: blur(25px);
            border-radius: 16px;
            padding: 15px;
            z-index: 900;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
            box-shadow: 0 -8px 30px var(--shadow-heavy);
        }

        .download-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .download-regions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .download-region {
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

            .download-region:active {
                transform: scale(0.98);
            }

        .region-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .region-size {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .download-progress {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }

        .download-progress-bar {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        /* ===== WEATHER PANEL ===== */
        #weatherPanel {
            position: fixed;
            bottom: 90px;
            left: 10px;
            right: 10px;
            max-height: 40vh;
            background: var(--bg-overlay);
            backdrop-filter: blur(25px);
            border-radius: 16px;
            padding: 15px;
            z-index: 900;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
            box-shadow: 0 -8px 30px var(--shadow-heavy);
        }

        .weather-current {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .weather-icon-large {
            font-size: 48px;
            margin-right: 20px;
        }

        .weather-temp {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .weather-desc {
            font-size: 14px;
            color: var(--text-tertiary);
            text-transform: capitalize;
        }

        .weather-forecast {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .weather-day {
            text-align: center;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .weather-day-name {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 5px;
        }

        .weather-day-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .weather-day-temp {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ===== EMERGENCY PANEL ===== */
        #emergencyPanel {
            position: fixed;
            bottom: 90px;
            left: 10px;
            right: 10px;
            max-height: 60vh;
            background: var(--bg-overlay);
            backdrop-filter: blur(25px);
            border-radius: 16px;
            padding: 15px;
            z-index: 900;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
            box-shadow: 0 -8px 30px var(--shadow-heavy);
            overflow: hidden; /* Prevent content overflow */
        }

        .emergency-contacts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .emergency-contact {
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 8px;
        }

        .emergency-icon {
            font-size: 24px;
            color: var(--red);
        }

        .emergency-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .emergency-number {
            font-size: 14px;
            color: var(--accent);
            font-weight: 600;
        }

        .safety-tips {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

            .safety-tips h4 {
                margin: 0 0 10px 0;
                color: var(--text-primary);
            }

            .safety-tips ul {
                margin: 0;
                padding-left: 20px;
                color: var(--text-secondary);
                font-size: 14px;
            }

            .safety-tips li {
                margin-bottom: 5px;
            }

        /* ===== RESPONSIVE ADJUSTMENTS ===== */
        @media (max-width: 480px) {
            .landing-content h1 {
                font-size: 24px;
            }

            .landing-content p {
                font-size: 15px;
            }

            .layer-btn, .prof-btn {
                font-size: 12px;
                padding: 8px 4px;
            }

            .details-title {
                font-size: 18px;
            }

            .sidebar-header h2,
            .route-header h3,
            .nav-header h3 {
                font-size: 18px;
            }

            .step-distance {
                font-size: 24px;
            }

            .step-text {
                font-size: 16px;
            }

            .current-step {
                min-height: 90px;
                padding: 15px;
            }

            #routePanel, #navPanel {
                max-height: 65vh;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .top-controls {
                flex-direction: row;
                gap: 10px;
            }

            .control-card {
                width: 50%;
            }

            .bottom-nav {
                height: 60px;
            }

            .nav-btn {
                min-width: 50px;
                padding: 6px 10px;
            }

            #routePanel, #navPanel {
                max-height: 70vh;
                bottom: 80px;
            }

            .details-card {
                max-height: 90vh;
            }

            .current-step {
                min-height: 80px;
                padding: 15px;
            }

            .step-list {
                max-height: 150px;
            }
        }

        @media (max-width: 320px) {
            .landing-content h1 {
                font-size: 22px;
            }

            .landing-content p {
                font-size: 14px;
            }

            .layer-btn, .prof-btn {
                font-size: 11px;
                padding: 6px 3px;
            }

            .nav-icon {
                font-size: 20px;
            }

            .nav-btn span:last-child {
                font-size: 10px;
            }

            .landing-logo {
                width: 100px;
                height: 100px;
            }

            .category-btn {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        /* High resolution screens */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .my-location-marker-inner,
            .place-marker-inner {
                border-width: 2px;
            }
        }

        /* Notch/safe area support */
        @supports (padding: max(0px)) {
            .sidebar-header {
                padding-top: max(env(safe-area-inset-top), 25px);
            }

            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }

            #routePanel, #navPanel, #downloadPanel, #weatherPanel, #emergencyPanel {
                bottom: calc(85px + env(safe-area-inset-bottom));
            }
        }

        /* ===== IMPROVED TOUCH HANDLING ===== */
        @media (max-width: 768px) {
            .category-bar {
                touch-action: pan-y;
            }

            .category-btn {
                touch-action: manipulation;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }

            .category-bar,
            .location-list,
            .waypoint-list,
            .step-list {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ===== ACCESSIBILITY IMPROVEMENTS ===== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for accessibility */
        button:focus-visible,
        .category-btn:focus-visible,
        .action-btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }
    </style>
</head>
<body>

    <!-- APP FRAME -->
    <div class="app-frame"></div>

    <!-- LOADING SCREEN -->
    <div id="loading">
        <div class="loading-spinner"></div>
        <div id="loadingText">Učitavanje...</div>
    </div>

    <!-- LANDING SCREEN -->
    <div id="landing-overlay">
        <div class="landing-content">
            <div class="landing-logo">
                <img src="logo.png" alt="BiH Outdoor Guide Logo" onerror="this.onerror=null; this.parentElement.innerHTML='🏔️';">
            </div>
            <h1 id="welcomeTitle">Dobro došli</h1>
            <p id="welcomeText">
                Dobro došli u čaroliju prirode Bosne i Hercegovine.
                Ova aplikacija je vaš vidič kroz vodopade, planine, staze i skrivene oaze.
                Istražite, pronađite put i doživite BiH na najljepši način.
            </p>

            <div class="theme-toggle-landing">
                <button class="theme-btn active" data-theme="light">☀️</button>
                <button class="theme-btn" data-theme="dark">🌙</button>
            </div>

            <select id="languageSelect" class="lang-select">
                <option value="bs">🇧🇦 Bosanski</option>
                <option value="en">🇬🇧 English</option>
                <option value="it">🇮🇹 Italiano</option>
                <option value="fr">🇫🇷 Français</option>
                <option value="es">🇪🇸 Español</option>
                <option value="de">🇩🇪 Deutsch</option>
            </select>
            <button class="landing-btn" id="continueBtn">Nastavi</button>
        </div>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- OFFLINE INDICATOR -->
    <div id="offlineIndicator" class="offline-indicator">🌐 Offline</div>

    <!-- THEME TOGGLE -->
    <button id="themeToggle">☀️</button>

    <!-- TOP CONTROLS -->
    <div class="top-controls">
        <div class="control-card">
            <button class="layer-btn active" data-layer="streets" id="layerStreets">🗺️ Ulice</button>
            <button class="layer-btn" data-layer="satellite" id="layerSatellite">🛰️ Satelit</button>
            <button class="layer-btn" data-layer="hybrid" id="layerHybrid">🌍 Hibrid</button>
        </div>
        <div class="control-card">
            <button class="prof-btn" data-prof="driving" id="profDriving">🚗 Auto</button>
            <button class="prof-btn active" data-prof="cycling" id="profCycling">🚴 Bicikl</button>
            <button class="prof-btn" data-prof="foot" id="profFoot">🚶 Pješke</button>
        </div>
    </div>

    <!-- SIDEBAR BUTTON -->
    <button id="openSidebarBtn">☰</button>

    <!-- SIDEBAR -->
    <aside id="sidebar">
        <div class="sidebar-header">
            <h2 id="locationsTitle">Lokacije</h2>
            <button id="closeSidebar">✕</button>
        </div>
        <div class="category-summary">
            <span id="selectedCategoriesText">Odabrano: 0 kategorija</span>
            <button class="clear-categories" id="clearCategoriesBtn">Obriši sve</button>
        </div>
        <div id="categoryBar" class="category-bar"></div>
        <div id="locationList" class="location-list"></div>
    </aside>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <button id="navRoute" class="nav-btn">
            <span class="nav-icon">📍</span>
            <span id="routeText">Ruta</span>
        </button>
        <button id="navCenter" class="nav-btn">
            <span class="nav-icon">🎯</span>
            <span id="centerText">Centar</span>
        </button>
        <button id="navDownload" class="nav-btn">
            <span class="nav-icon">📥</span>
            <span id="downloadText">Preuzmi</span>
        </button>
        <button id="navWeather" class="nav-btn">
            <span class="nav-icon">☀️</span>
            <span id="weatherText">Vrijeme</span>
        </button>
        <button id="navEmergency" class="nav-btn">
            <span class="nav-icon">🚨</span>
            <span id="emergencyText">Hitno</span>
        </button>
        <button id="navShare" class="nav-btn">
            <span class="nav-icon">🔗</span>
            <span id="shareText">Podijeli</span>
        </button>
    </nav>

    <!-- EXTENDED BOTTOM NAVIGATION (Visible when route is active) -->
    <nav id="extendedNav" class="bottom-nav" style="display: none; bottom: 80px;">
        <button id="navStartFromMe" class="nav-btn">
            <span class="nav-icon">🚀</span>
            <span id="startFromMeText">Start od mene</span>
        </button>
        <button id="navStart" class="nav-btn">
            <span class="nav-icon">▶️</span>
            <span id="startText">Start</span>
        </button>
        <button id="navStop" class="nav-btn">
            <span class="nav-icon">⏹️</span>
            <span id="stopText">Stop</span>
        </button>
        <button id="navClear" class="nav-btn">
            <span class="nav-icon">🗑️</span>
            <span id="clearText">Obriši</span>
        </button>
    </nav>

    <!-- ROUTE PANEL -->
    <div id="routePanel">
        <div class="route-header">
            <h3 id="routePanelTitle">Plan rute</h3>
            <button class="close-btn" onclick="toggleRoutePanel()">✕</button>
        </div>
        <div class="route-info">
            <div class="route-stat">
                <div class="stat-value" id="totalDistance">0 km</div>
                <div class="stat-label" id="distanceLabel">Ukupno</div>
            </div>
            <div class="route-stat">
                <div class="stat-value" id="totalTime">0 min</div>
                <div class="stat-label" id="timeLabel">Vrijeme</div>
            </div>
            <div class="route-stat">
                <div class="stat-value" id="waypointCount">0</div>
                <div class="stat-label" id="stopsLabel">Stajališta</div>
            </div>
        </div>
        <div id="waypointList" class="waypoint-list"></div>
        <div class="details-actions" style="margin-top: 10px;">
            <button class="action-btn primary" onclick="startNavigation()" id="startRouteBtn">
                ▶️ Započni navigaciju
            </button>
            <button class="action-btn secondary" onclick="startNavigationFromMyLocation()" id="startFromMyLocationBtn">
                🚀 Start od mene
            </button>
        </div>
    </div>

    <!-- NAVIGATION PANEL -->
    <div id="navPanel">
        <div class="nav-header">
            <h3 id="navPanelTitle">Navigacija</h3>
            <div class="nav-controls">
                <button class="nav-control-btn" onclick="toggleVoice()" id="voiceBtn">🔊</button>
                <button class="nav-control-btn" onclick="toggleNavPanel()" id="collapseBtn">▼</button>
                <button class="nav-control-btn" onclick="stopNavigation()">✕</button>
            </div>
        </div>

        <div class="current-step">
            <div class="step-distance" id="currentDistance">0 m</div>
            <div class="step-text" id="currentInstruction">Slijedite rutu</div>
        </div>

        <div id="stepList" class="step-list"></div>
    </div>

    <!-- DOWNLOAD PANEL -->
    <div id="downloadPanel">
        <div class="download-header">
            <h3 id="downloadPanelTitle">Preuzmi karte</h3>
            <button class="close-btn" onclick="toggleDownloadPanel()">✕</button>
        </div>
        <p style="color: var(--text-tertiary); margin-bottom: 15px; font-size: 14px;">
            Preuzmite karte za korištenje van mreže. Karte će biti spremljene u vašem uređaju.
        </p>
        <div id="regionList" class="download-regions"></div>
        <div id="downloadStatus" style="display: none;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span id="downloadingRegion">Preuzimanje...</span>
                <span id="downloadProgressText">0%</span>
            </div>
            <div class="download-progress">
                <div id="downloadProgressBar" class="download-progress-bar"></div>
            </div>
        </div>
        <div class="details-actions" style="margin-top: 10px;">
            <button class="action-btn primary" onclick="downloadAllRegions()" id="downloadAllBtn">
                📥 Preuzmi sve
            </button>
        </div>
    </div>

    <!-- WEATHER PANEL -->
    <div id="weatherPanel">
        <div class="download-header">
            <h3 id="weatherPanelTitle">Vremenska prognoza</h3>
            <button class="close-btn" onclick="toggleWeatherPanel()">✕</button>
        </div>
        <div id="weatherCurrent" class="weather-current">
            <i class="weather-icon-large wi wi-day-sunny"></i>
            <div>
                <div class="weather-temp" id="currentTemp">--°C</div>
                <div class="weather-desc" id="currentDesc">Učitavam...</div>
            </div>
        </div>
        <div id="weatherForecast" class="weather-forecast"></div>
    </div>

    <!-- EMERGENCY PANEL -->
    <div id="emergencyPanel">
        <div class="download-header">
            <h3 id="emergencyPanelTitle">Hitne informacije</h3>
            <button class="close-btn" onclick="toggleEmergencyPanel()">✕</button>
        </div>
        <div class="emergency-contacts">
            <div class="emergency-contact">
                <div class="emergency-icon">🚑</div>
                <div class="emergency-name">Hitna pomoć</div>
                <div class="emergency-number">124</div>
            </div>
            <div class="emergency-contact">
                <div class="emergency-icon">🚓</div>
                <div class="emergency-name">Policija</div>
                <div class="emergency-number">122</div>
            </div>
            <div class="emergency-contact">
                <div class="emergency-icon">🚒</div>
                <div class="emergency-name">Vatrogasci</div>
                <div class="emergency-number">123</div>
            </div>
            <div class="emergency-contact">
                <div class="emergency-icon">🆘</div>
                <div class="emergency-name">Spašavanje</div>
                <div class="emergency-number">121</div>
            </div>
        </div>
        <div class="safety-tips">
            <h4>Sigurnosni savjeti:</h4>
            <ul>
                <li>Uvijek obavijestite nekoga o vašoj planiranoj ruti</li>
                <li>Ponesite dovoljno vode i hrane</li>
                <li>Provjerite vremensku prognozu prije polaska</li>
                <li>Imajte punu bateriju na telefonu</li>
                <li>Nosite odgovarajuću opremu i odjeću</li>
            </ul>
        </div>
    </div>

    <!-- SHARE MODAL -->
    <div id="shareModal">
        <div class="share-card">
            <div class="share-header">
                <h3 id="shareModalTitle">Podijeli rutu</h3>
                <button class="close-btn" onclick="toggleShareModal()">✕</button>
            </div>
            <div class="share-options">
                <div class="share-option" onclick="shareVia('whatsapp')">
                    <div class="share-icon">📱</div>
                    <div class="share-label">WhatsApp</div>
                </div>
                <div class="share-option" onclick="shareVia('facebook')">
                    <div class="share-icon">📘</div>
                    <div class="share-label">Facebook</div>
                </div>
                <div class="share-option" onclick="shareVia('twitter')">
                    <div class="share-icon">🐦</div>
                    <div class="share-label">Twitter</div>
                </div>
                <div class="share-option" onclick="shareVia('copy')">
                    <div class="share-icon">📋</div>
                    <div class="share-label">Kopiraj</div>
                </div>
            </div>
            <div class="share-url">
                <input type="text" id="shareUrl" readonly value="https://bih-outdoor.app/route/...">
                <button class="copy-btn" onclick="copyShareUrl()">Kopiraj</button>
            </div>
        </div>
    </div>

    <!-- DETAILS MODAL -->
    <div id="detailsModal">
        <div class="details-card">
            <div class="details-header">
                <div>
                    <h2 class="details-title" id="detailTitle">Naslov</h2>
                    <span class="details-category" id="detailCategory">Kategorija</span>
                </div>
                <button class="close-btn" onclick="closeDetails()">✕</button>
            </div>
            <div class="details-image" id="detailImage"></div>
            <div class="details-meta">
                <div class="meta-item">
                    <div class="meta-icon">⏱️</div>
                    <div class="meta-content">
                        <div class="meta-label" id="difficultyLabel">Težina</div>
                        <div class="meta-value" id="detailDifficulty">Lako</div>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-icon">🕒</div>
                    <div class="meta-content">
                        <div class="meta-label" id="durationLabel">Trajanje</div>
                        <div class="meta-value" id="detailDuration">2 sata</div>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-icon">📏</div>
                    <div class="meta-content">
                        <div class="meta-label" id="distanceLabel">Udaljenost</div>
                        <div class="meta-value" id="detailDistance">5 km</div>
                    </div>
                </div>
                <div class="meta-item">
                    <div class="meta-icon">📈</div>
                    <div class="meta-content">
                        <div class="meta-label" id="elevationLabel">Visina</div>
                        <div class="meta-value" id="detailElevation">300 m</div>
                    </div>
                </div>
            </div>
            <p class="details-desc" id="detailDesc">Opis lokacije...</p>

            <div class="access-info" id="accessInfo" style="display: none;">
                <div class="access-title">
                    <span>🚶‍♂️ Pristup pešice</span>
                </div>
                <div class="access-details" id="accessDetails">
                    Ova lokacija nije direktno dostupna automobilom. Posljednji dio puta morate preći pešice.
                </div>
            </div>

            <div class="details-actions">
                <button class="action-btn primary" onclick="addAsStop()" id="addStopBtn">
                    🛑 Dodaj stanicu
                </button>
                <button class="action-btn secondary" onclick="addAsDestination()" id="addDestBtn">
                    🎯 Postavi cilj
                </button>
                <button class="action-btn secondary" onclick="startRouteFromMeToHere()" id="routeFromMeBtn">
                    🚀 Od mene ovdje
                </button>
                <button class="action-btn warning" onclick="createRouteFromLastToHere()" id="continueRouteBtn">
                    ➕ Nastavi rutu
                </button>
            </div>

            <button class="close-modal" onclick="closeDetails()" id="closeDetailsBtn">Zatvori</button>
        </div>
    </div>

    <script>
        // ===== CONFIGURATION =====
        const GH_KEY = '6d724d22-b448-42c5-8ac1-e889c30aea4e';
        const MAPTILER_KEY = 'U03LXjD0O7Kak1JMW2c2';
        const WEATHER_API_KEY = 'your_weather_api_key_here'; // Replace with actual API key
        const OFFLINE_STORAGE_KEY = 'bih_outdoor_offline_data';
        const CACHE_VERSION = 'v1.0';

        // ===== STATE MANAGEMENT =====
        let state = {
            language: 'bs',
            theme: 'light',
            places: [],
            selectedCategories: new Set(['all']),
            currentProfile: 'cycling',
            currentLayer: 'streets',
            routePoints: [],
            myLocation: null,
            currentRoute: null,
            isNavigating: false,
            voiceEnabled: false,
            watchId: null,
            currentStep: 0,
            map: null,
            markers: [],
            myLocationMarker: null,
            routeLine: null,
            routeArrows: null,
            routeDashedLines: [],
            instructions: [],
            detailsPlace: null,
            is3DMode: false,
            navPanelCollapsed: false,
            walkingSections: [],
            inaccessibleRoutes: [],
            sidebarVisible: false,
            isOnline: navigator.onLine,
            offlineMaps: JSON.parse(localStorage.getItem('offline_maps') || '{}'),
            weatherData: {},
            userReviews: JSON.parse(localStorage.getItem('user_reviews') || '[]'),
            emergencyContacts: [
                { name: 'Hitna pomoć', number: '124', icon: '🚑' },
                { name: 'Policija', number: '122', icon: '🚓' },
                { name: 'Vatrogasci', number: '123', icon: '🚒' },
                { name: 'Spašavanje', number: '121', icon: '🆘' },
                { name: 'Planinarska služba', number: '033 555 666', icon: '🏔️' },
                { name: 'Vatrogasna služba', number: '123', icon: '🔥' }
            ]
        };

        // ===== GLOBAL VARIABLES =====
        let markersInitialized = false;
        let routeSourceId = null;
        let routeLayerId = null;
        let weatherUpdateInterval = null;
        let isStyleChanging = false;
        let routeIconAttempts = 0;
        let routeCalculationTimeout = null;
        let lastRouteRequest = 0;
        const MIN_REQUEST_INTERVAL = 1000; // 1 second minimum between requests

        // ===== TRANSLATIONS - COMPLETE AND UPDATED =====
        const translations = {
            bs: {
                welcomeTitle: "Dobro došli",
                welcomeText: "Dobro došli u čaroliju prirode Bosne i Hercegovine. Ova aplikacija je vaš vidič kroz vodopade, planine, staze i skrivene oaze. Istražite, pronađite put i doživite BiH na najljepši način.",
                continue: "Nastavi",
                locationsTitle: "Lokacije",
                selectedCategories: "Odabrano:",
                clearAllCategories: "Obriši sve",
                allCategories: "Sve",
                categoryText: "kategorija",
                categoriesText: "kategorije",
                layerStreets: "🗺️ Ulice",
                layerSatellite: "🛰️ Satelit",
                layerHybrid: "🌍 Hibrid",
                profDriving: "🚗 Auto",
                profCycling: "🚴 Bicikl",
                profFoot: "🚶 Pješke",
                routeText: "Ruta",
                centerText: "Centar",
                downloadText: "Preuzmi",
                weatherText: "Vrijeme",
                emergencyText: "Hitno",
                shareText: "Podijeli",
                startFromMeText: "Start od mene",
                startText: "Start",
                stopText: "Stop",
                clearText: "Obriši",
                routePanelTitle: "Plan rute",
                distanceLabel: "Ukupno",
                timeLabel: "Vrijeme",
                stopsLabel: "Stajališta",
                startRouteBtn: "▶️ Započni navigaciju",
                startFromMyLocation: "🚀 Start od mene",
                navPanelTitle: "Navigacija",
                voiceOn: "🔊 Uključi",
                voiceOff: "🔇 Isključi",
                downloadPanelTitle: "Preuzmi karte",
                downloadAll: "📥 Preuzmi sve",
                weatherPanelTitle: "Vremenska prognoza",
                weatherLoading: "Učitavam...",
                emergencyPanelTitle: "Hitne informacije",
                safetyTips: "Sigurnosni savjeti:",
                shareModalTitle: "Podijeli rutu",
                addStopBtn: "🛑 Dodaj stanicu",
                addDestBtn: "🎯 Postavi cilj",
                routeFromMeBtn: "🚀 Od mene ovdje",
                continueRouteBtn: "➕ Nastavi rutu",
                closeDetailsBtn: "Zatvori",
                difficultyLabel: "Težina",
                durationLabel: "Trajanje",
                distanceLabel: "Udaljenost",
                elevationLabel: "Visina",
                difficultyEasy: "Lako",
                difficultyMedium: "Srednje",
                difficultyHard: "Teško",
                difficultyExtreme: "Ekstremno",
                footAccess: "🚶 Pristup pešice",
                carAccess: "🚗 Pristup autom",
                bikeAccess: "🚴 Pristup biciklom",
                mixedAccess: "🚗+🚶 Mješoviti pristup",
                categories: {
                    all: "Sve",
                    hiking: "Planinarenje",
                    ski: "Skijanje",
                    historic: "Povijesno",
                    extreme: "Ekstremno",
                    national_park: "Nacionalni park",
                    camping: "Kampiranje",
                    mtb: "MTB",
                    spring: "Izvor",
                    lake: "Jezero",
                    waterfall: "Vodopad",
                    rafting: "Rafting"
                },
                weatherSunny: "Sunčano",
                weatherCloudy: "Oblačno",
                weatherRainy: "Kišovito",
                weatherSnow: "Snijeg",
                weatherStorm: "Oluja",
                loading: "Učitavanje...",
                noLocation: "Nema lokacije",
                myLocation: "Moja lokacija",
                routeEmpty: "Ruta je prazna",
                startNavigation: "Započni navigaciju",
                stopNavigation: "Zaustavi navigaciju",
                clearRoute: "Obriši rutu",
                followingRoute: "Pratite rutu",
                destinationReached: "Stigli ste na odredište",
                turnLeft: "Skrenite lijevo",
                turnRight: "Skrenite desno",
                continueStraight: "Nastavite ravno",
                online: "🌐 Online",
                offline: "🌐 Offline"
            },
            en: {
                welcomeTitle: "Welcome",
                welcomeText: "Welcome to the natural wonders of Bosnia and Herzegovina. This application is your guide through waterfalls, mountains, trails and hidden oases. Explore, navigate and experience BiH in the best way.",
                continue: "Continue",
                locationsTitle: "Locations",
                selectedCategories: "Selected:",
                clearAllCategories: "Clear all",
                allCategories: "All",
                categoryText: "category",
                categoriesText: "categories",
                layerStreets: "🗺️ Streets",
                layerSatellite: "🛰️ Satellite",
                layerHybrid: "🌍 Hybrid",
                profDriving: "🚗 Car",
                profCycling: "🚴 Bike",
                profFoot: "🚶 Walking",
                routeText: "Route",
                centerText: "Center",
                downloadText: "Download",
                weatherText: "Weather",
                emergencyText: "Emergency",
                shareText: "Share",
                startFromMeText: "Start from Me",
                startText: "Start",
                stopText: "Stop",
                clearText: "Clear",
                routePanelTitle: "Route Plan",
                distanceLabel: "Total",
                timeLabel: "Time",
                stopsLabel: "Stops",
                startRouteBtn: "▶️ Start Navigation",
                startFromMyLocation: "🚀 Start from Me",
                navPanelTitle: "Navigation",
                voiceOn: "🔊 On",
                voiceOff: "🔇 Off",
                downloadPanelTitle: "Download Maps",
                downloadAll: "📥 Download All",
                weatherPanelTitle: "Weather Forecast",
                weatherLoading: "Loading...",
                emergencyPanelTitle: "Emergency Information",
                safetyTips: "Safety Tips:",
                shareModalTitle: "Share Route",
                addStopBtn: "🛑 Add Stop",
                addDestBtn: "🎯 Set Destination",
                routeFromMeBtn: "🚀 From Me to Here",
                continueRouteBtn: "➕ Continue Route",
                closeDetailsBtn: "Close",
                difficultyLabel: "Difficulty",
                durationLabel: "Duration",
                distanceLabel: "Distance",
                elevationLabel: "Elevation",
                difficultyEasy: "Easy",
                difficultyMedium: "Medium",
                difficultyHard: "Hard",
                difficultyExtreme: "Extreme",
                footAccess: "🚶 Foot access",
                carAccess: "🚗 Car access",
                bikeAccess: "🚴 Bike access",
                mixedAccess: "🚗+🚶 Mixed access",
                categories: {
                    all: "All",
                    hiking: "Hiking",
                    ski: "Skiing",
                    historic: "Historic",
                    extreme: "Extreme",
                    national_park: "National Park",
                    camping: "Camping",
                    mtb: "MTB",
                    spring: "Spring",
                    lake: "Lake",
                    waterfall: "Waterfall",
                    rafting: "Rafting"
                },
                weatherSunny: "Sunny",
                weatherCloudy: "Cloudy",
                weatherRainy: "Rainy",
                weatherSnow: "Snow",
                weatherStorm: "Storm",
                loading: "Loading...",
                noLocation: "No location",
                myLocation: "My location",
                routeEmpty: "Route is empty",
                startNavigation: "Start navigation",
                stopNavigation: "Stop navigation",
                clearRoute: "Clear route",
                followingRoute: "Following route",
                destinationReached: "Destination reached",
                turnLeft: "Turn left",
                turnRight: "Turn right",
                continueStraight: "Continue straight",
                online: "🌐 Online",
                offline: "🌐 Offline"
            },
            it: {
                welcomeTitle: "Benvenuti",
                welcomeText: "Benvenuti nelle meraviglie naturali della Bosnia ed Erzegovina. Questa applicazione è la vostra guida attraverso cascate, montagne, sentieri e oasi nascoste. Esplorate, navigate e vivete la BiH nel modo migliore.",
                continue: "Continua",
                locationsTitle: "Località",
                selectedCategories: "Selezionato:",
                clearAllCategories: "Cancella tutto",
                allCategories: "Tutti",
                categoryText: "categoria",
                categoriesText: "categorie",
                layerStreets: "🗺️ Strade",
                layerSatellite: "🛰️ Satellite",
                layerHybrid: "🌍 Ibrido",
                profDriving: "🚗 Auto",
                profCycling: "🚴 Bici",
                profFoot: "🚶 A piedi",
                routeText: "Percorso",
                centerText: "Centro",
                downloadText: "Scarica",
                weatherText: "Tempo",
                emergencyText: "Emergenza",
                shareText: "Condividi",
                startFromMeText: "Inizia da me",
                startText: "Inizio",
                stopText: "Stop",
                clearText: "Cancella",
                routePanelTitle: "Piano percorso",
                distanceLabel: "Totale",
                timeLabel: "Tempo",
                stopsLabel: "Fermate",
                startRouteBtn: "▶️ Inizia navigazione",
                startFromMyLocation: "🚀 Inizia da me",
                navPanelTitle: "Navigazione",
                voiceOn: "🔊 Attiva",
                voiceOff: "🔇 Disattiva",
                downloadPanelTitle: "Scarica mappe",
                downloadAll: "📥 Scarica tutto",
                weatherPanelTitle: "Previsioni meteo",
                weatherLoading: "Caricamento...",
                emergencyPanelTitle: "Informazioni emergenza",
                safetyTips: "Consigli sicurezza:",
                shareModalTitle: "Condividi percorso",
                addStopBtn: "🛑 Aggiungi fermata",
                addDestBtn: "🎯 Imposta destinazione",
                routeFromMeBtn: "🚀 Da me a qui",
                continueRouteBtn: "➕ Continua percorso",
                closeDetailsBtn: "Chiudi",
                difficultyLabel: "Difficoltà",
                durationLabel: "Durata",
                distanceLabel: "Distanza",
                elevationLabel: "Altitudine",
                difficultyEasy: "Facile",
                difficultyMedium: "Medio",
                difficultyHard: "Difficile",
                difficultyExtreme: "Estremo",
                footAccess: "🚶 Accesso a piedi",
                carAccess: "🚗 Accesso in auto",
                bikeAccess: "🚴 Accesso in bici",
                mixedAccess: "🚗+🚶 Accesso misto",
                categories: {
                    all: "Tutti",
                    hiking: "Escursionismo",
                    ski: "Sci",
                    historic: "Storico",
                    extreme: "Estremo",
                    national_park: "Parco Nazionale",
                    camping: "Campeggio",
                    mtb: "MTB",
                    spring: "Sorgente",
                    lake: "Lago",
                    waterfall: "Cascada",
                    rafting: "Rafting"
                },
                weatherSunny: "Soleggiato",
                weatherCloudy: "Nuvoloso",
                weatherRainy: "Piovoso",
                weatherSnow: "Neve",
                weatherStorm: "Tempesta",
                loading: "Caricamento...",
                noLocation: "Nessuna posizione",
                myLocation: "La mia posizione",
                routeEmpty: "Percorso vuoto",
                startNavigation: "Inizia navigazione",
                stopNavigation: "Ferma navigazione",
                clearRoute: "Cancella percorso",
                followingRoute: "Seguendo il percorso",
                destinationReached: "Destinazione raggiunta",
                turnLeft: "Gira a sinistra",
                turnRight: "Gira a destra",
                continueStraight: "Continua dritto",
                online: "🌐 Online",
                offline: "🌐 Offline"
            },
            fr: {
                welcomeTitle: "Bienvenue",
                welcomeText: "Bienvenue parmi les merveilles naturelles de la Bosnie-Herzégovine. Cette application est votre guide à travers chutes d'eau, montagnes, sentiers et oasis cachées. Explorez, naviguez et découvrez la BiH de la plus belle manière.",
                continue: "Continuer",
                locationsTitle: "Lieux",
                selectedCategories: "Sélectionné:",
                clearAllCategories: "Effacer tout",
                allCategories: "Tous",
                categoryText: "catégorie",
                categoriesText: "catégories",
                layerStreets: "🗺️ Rues",
                layerSatellite: "🛰️ Satellite",
                layerHybrid: "🌍 Hybride",
                profDriving: "🚗 Voiture",
                profCycling: "🚴 Vélo",
                profFoot: "🚶 Marche",
                routeText: "Itinéraire",
                centerText: "Centre",
                downloadText: "Télécharger",
                weatherText: "Météo",
                emergencyText: "Urgence",
                shareText: "Partager",
                startFromMeText: "Démarrer de moi",
                startText: "Démarrer",
                stopText: "Arrêter",
                clearText: "Effacer",
                routePanelTitle: "Plan d'itinéraire",
                distanceLabel: "Total",
                timeLabel: "Temps",
                stopsLabel: "Arrêts",
                startRouteBtn: "▶️ Démarrer navigation",
                startFromMyLocation: "🚀 Démarrer de moi",
                navPanelTitle: "Navigation",
                voiceOn: "🔊 Activé",
                voiceOff: "🔇 Désactivé",
                downloadPanelTitle: "Télécharger cartes",
                downloadAll: "📥 Télécharger tout",
                weatherPanelTitle: "Prévisions météo",
                weatherLoading: "Chargement...",
                emergencyPanelTitle: "Informations d'urgence",
                safetyTips: "Conseils de sécurité:",
                shareModalTitle: "Partager itinéraire",
                addStopBtn: "🛑 Ajouter arrêt",
                addDestBtn: "🎯 Définir destination",
                routeFromMeBtn: "🚀 De moi à ici",
                continueRouteBtn: "➕ Continuer itinéraire",
                closeDetailsBtn: "Fermer",
                difficultyLabel: "Difficulté",
                durationLabel: "Durée",
                distanceLabel: "Distance",
                elevationLabel: "Altitude",
                difficultyEasy: "Facile",
                difficultyMedium: "Moyen",
                difficultyHard: "Difficile",
                difficultyExtreme: "Extrême",
                footAccess: "🚶 Accès à pied",
                carAccess: "🚗 Accès en voiture",
                bikeAccess: "🚴 Accès à vélo",
                mixedAccess: "🚗+🚶 Accès mixte",
                categories: {
                    all: "Tous",
                    hiking: "Randonnée",
                    ski: "Ski",
                    historic: "Historique",
                    extreme: "Extrême",
                    national_park: "Parc National",
                    camping: "Camping",
                    mtb: "VTT",
                    spring: "Source",
                    lake: "Lac",
                    waterfall: "Cascade",
                    rafting: "Rafting"
                },
                weatherSunny: "Ensoleillé",
                weatherCloudy: "Nuageux",
                weatherRainy: "Pluvieux",
                weatherSnow: "Neige",
                weatherStorm: "Tempête",
                loading: "Chargement...",
                noLocation: "Pas de position",
                myLocation: "Ma position",
                routeEmpty: "Itinéraire vide",
                startNavigation: "Démarrer navigation",
                stopNavigation: "Arrêter navigation",
                clearRoute: "Effacer itinéraire",
                followingRoute: "Suivre l'itinéraire",
                destinationReached: "Destination atteinte",
                turnLeft: "Tournez à gauche",
                turnRight: "Tournez à droite",
                continueStraight: "Continuez tout droit",
                online: "🌐 Online",
                offline: "🌐 Offline"
            },
            es: {
                welcomeTitle: "Bienvenidos",
                welcomeText: "Bienvenidos a las maravillas naturales de Bosnia y Herzegovina. Esta aplicación es su guía por cascadas, montañas, senderos y oasis ocultos. Explore, navegue y experimente BiH de la mejor manera.",
                continue: "Continuar",
                locationsTitle: "Ubicaciones",
                selectedCategories: "Seleccionado:",
                clearAllCategories: "Limpiar todo",
                allCategories: "Todos",
                categoryText: "categoría",
                categoriesText: "categorías",
                layerStreets: "🗺️ Calles",
                layerSatellite: "🛰️ Satélite",
                layerHybrid: "🌍 Híbrido",
                profDriving: "🚗 Coche",
                profCycling: "🚴 Bici",
                profFoot: "🚶 Caminar",
                routeText: "Ruta",
                centerText: "Centrar",
                downloadText: "Descargar",
                weatherText: "Tiempo",
                emergencyText: "Emergencia",
                shareText: "Compartir",
                startFromMeText: "Iniciar desde mí",
                startText: "Iniciar",
                stopText: "Detener",
                clearText: "Limpiar",
                routePanelTitle: "Plan de ruta",
                distanceLabel: "Total",
                timeLabel: "Tiempo",
                stopsLabel: "Paradas",
                startRouteBtn: "▶️ Iniciar navegación",
                startFromMyLocation: "🚀 Iniciar desde mí",
                navPanelTitle: "Navegación",
                voiceOn: "🔊 Activado",
                voiceOff: "🔇 Desactivado",
                downloadPanelTitle: "Descargar mapas",
                downloadAll: "📥 Descargar todo",
                weatherPanelTitle: "Pronóstico del tiempo",
                weatherLoading: "Cargando...",
                emergencyPanelTitle: "Información de emergencia",
                safetyTips: "Consejos de seguridad:",
                shareModalTitle: "Compartir ruta",
                addStopBtn: "🛑 Añadir parada",
                addDestBtn: "🎯 Establecer destino",
                routeFromMeBtn: "🚀 De mí a aquí",
                continueRouteBtn: "➕ Continuar ruta",
                closeDetailsBtn: "Cerrar",
                difficultyLabel: "Dificultad",
                durationLabel: "Duración",
                distanceLabel: "Distancia",
                elevationLabel: "Altitud",
                difficultyEasy: "Fácil",
                difficultyMedium: "Medio",
                difficultyHard: "Difícil",
                difficultyExtreme: "Extremo",
                footAccess: "🚶 Acceso a pie",
                carAccess: "🚗 Acceso en coche",
                bikeAccess: "🚴 Acceso en bici",
                mixedAccess: "🚗+🚶 Acceso mixto",
                categories: {
                    all: "Todos",
                    hiking: "Senderismo",
                    ski: "Esquí",
                    historic: "Histórico",
                    extreme: "Extremo",
                    national_park: "Parque Nacional",
                    camping: "Camping",
                    mtb: "MTB",
                    spring: "Manantial",
                    lake: "Lago",
                    waterfall: "Cascada",
                    rafting: "Rafting"
                },
                weatherSunny: "Soleado",
                weatherCloudy: "Nublado",
                weatherRainy: "Lluvioso",
                weatherSnow: "Nieve",
                weatherStorm: "Tormenta",
                loading: "Cargando...",
                noLocation: "Sin ubicación",
                myLocation: "Mi ubicación",
                routeEmpty: "Ruta vacía",
                startNavigation: "Iniciar navegación",
                stopNavigation: "Detener navegación",
                clearRoute: "Limpiar ruta",
                followingRoute: "Siguiendo ruta",
                destinationReached: "Destino alcanzado",
                turnLeft: "Gire a la izquierda",
                turnRight: "Gire a la derecha",
                continueStraight: "Continúe recto",
                online: "🌐 Online",
                offline: "🌐 Offline"
            },
            de: {
                welcomeTitle: "Willkommen",
                welcomeText: "Willkommen in den Naturschönheiten Bosnien und Herzegowinas. Diese App ist Ihr Führer durch Wasserfälle, Berge, Wege und versteckte Oasen. Erkunden Sie, navigieren Sie erleben Sie BiH auf die schönste Weise.",
                continue: "Weiter",
                locationsTitle: "Orte",
                selectedCategories: "Ausgewählt:",
                clearAllCategories: "Alle löschen",
                allCategories: "Alle",
                categoryText: "Kategorie",
                categoriesText: "Kategorien",
                layerStreets: "🗺️ Straßen",
                layerSatellite: "🛰️ Satellit",
                layerHybrid: "🌍 Hybrid",
                profDriving: "🚗 Auto",
                profCycling: "🚴 Fahrrad",
                profFoot: "🚶 Gehen",
                routeText: "Route",
                centerText: "Zentrieren",
                downloadText: "Herunterladen",
                weatherText: "Wetter",
                emergencyText: "Notfall",
                shareText: "Teilen",
                startFromMeText: "Von mir starten",
                startText: "Start",
                stopText: "Stop",
                clearText: "Löschen",
                routePanelTitle: "Routenplan",
                distanceLabel: "Gesamt",
                timeLabel: "Zeit",
                stopsLabel: "Stopps",
                startRouteBtn: "▶️ Navigation starten",
                startFromMyLocation: "🚀 Von mir starten",
                navPanelTitle: "Navigation",
                voiceOn: "🔊 Ein",
                voiceOff: "🔇 Aus",
                downloadPanelTitle: "Karten herunterladen",
                downloadAll: "📥 Alle herunterladen",
                weatherPanelTitle: "Wettervorhersage",
                weatherLoading: "Laden...",
                emergencyPanelTitle: "Notfallinformationen",
                safetyTips: "Sicherheitstipps:",
                shareModalTitle: "Route teilen",
                addStopBtn: "🛑 Halt hinzufügen",
                addDestBtn: "🎯 Ziel festlegen",
                routeFromMeBtn: "🚀 Von mir zu hier",
                continueRouteBtn: "➕ Route fortsetzen",
                closeDetailsBtn: "Schließen",
                difficultyLabel: "Schwierigkeit",
                durationLabel: "Dauer",
                distanceLabel: "Entfernung",
                elevationLabel: "Höhe",
                difficultyEasy: "Leicht",
                difficultyMedium: "Mittel",
                difficultyHard: "Schwer",
                difficultyExtreme: "Extrem",
                footAccess: "🚶 Zu Fuß erreichbar",
                carAccess: "🚗 Mit Auto erreichbar",
                bikeAccess: "🚴 Mit Fahrrad erreichbar",
                mixedAccess: "🚗+🚶 Gemischter Zugang",
                categories: {
                    all: "Alle",
                    hiking: "Wandern",
                    ski: "Skifahren",
                    historic: "Historisch",
                    extreme: "Extrem",
                    national_park: "Nationalpark",
                    camping: "Camping",
                    mtb: "MTB",
                    spring: "Quelle",
                    lake: "See",
                    waterfall: "Wasserfall",
                    rafting: "Rafting"
                },
                weatherSunny: "Sonnig",
                weatherCloudy: "Bewölkt",
                weatherRainy: "Regnerisch",
                weatherSnow: "Schnee",
                weatherStorm: "Sturm",
                loading: "Laden...",
                noLocation: "Kein Standort",
                myLocation: "Mein Standort",
                routeEmpty: "Route ist leer",
                startNavigation: "Navigation starten",
                stopNavigation: "Navigation stoppen",
                clearRoute: "Route löschen",
                followingRoute: "Route folgen",
                destinationReached: "Ziel erreicht",
                turnLeft: "Links abbiegen",
                turnRight: "Rechts abbiegen",
                continueStraight: "Geradeaus weiter",
                online: "🌐 Online",
                offline: "🌐 Offline"
            }
        };

        // ===== UTILITY FUNCTIONS =====
        function $(id) { return document.getElementById(id); }
        function create(tag, className) {
            const el = document.createElement(tag);
            if (className) el.className = className;
            return el;
        }

        function translate(key, lang = state.language) {
            const keys = key.split('.');
            let value = translations[lang];
            if (!value) value = translations['bs'];

            for (const k of keys) {
                if (value && typeof value === 'object' && k in value) {
                    value = value[k];
                } else {
                    if (lang !== 'bs') {
                        const defaultValue = translations['bs'];
                        let defaultVal = defaultValue;
                        for (const k2 of keys) {
                            if (defaultVal && typeof defaultVal === 'object' && k2 in defaultVal) {
                                defaultVal = defaultVal[k2];
                            } else {
                                defaultVal = undefined;
                                break;
                            }
                        }
                        if (defaultVal) return defaultVal;
                    }
                    return key;
                }
            }
            return value || key;
        }

        function updateAllTranslations() {
            const lang = state.language;

            // Landing page
            updateLandingPage(lang);

            // Sidebar
            $('locationsTitle').textContent = translate('locationsTitle', lang);

            const categoryCount = state.selectedCategories.size;
            let categoryText;
            if (categoryCount === 1 && state.selectedCategories.has('all')) {
                categoryText = translate('allCategories', lang);
            } else if (categoryCount === 1) {
                categoryText = `${categoryCount} ${translate('categoryText', lang)}`;
            } else {
                categoryText = `${categoryCount} ${translate('categoriesText', lang)}`;
            }
            $('selectedCategoriesText').textContent = `${translate('selectedCategories', lang)} ${categoryText}`;
            $('clearCategoriesBtn').textContent = translate('clearAllCategories', lang);

            // Top controls
            $('layerStreets').textContent = translate('layerStreets', lang);
            $('layerSatellite').textContent = translate('layerSatellite', lang);
            $('layerHybrid').textContent = translate('layerHybrid', lang);
            $('profDriving').textContent = translate('profDriving', lang);
            $('profCycling').textContent = translate('profCycling', lang);
            $('profFoot').textContent = translate('profFoot', lang);

            // Bottom navigation
            $('routeText').textContent = translate('routeText', lang);
            $('centerText').textContent = translate('centerText', lang);
            $('downloadText').textContent = translate('downloadText', lang);
            $('weatherText').textContent = translate('weatherText', lang);
            $('emergencyText').textContent = translate('emergencyText', lang);
            $('shareText').textContent = translate('shareText', lang);
            $('startFromMeText').textContent = translate('startFromMeText', lang);
            $('startText').textContent = translate('startText', lang);
            $('stopText').textContent = translate('stopText', lang);
            $('clearText').textContent = translate('clearText', lang);

            // Route panel
            $('routePanelTitle').textContent = translate('routePanelTitle', lang);
            $('distanceLabel').textContent = translate('distanceLabel', lang);
            $('timeLabel').textContent = translate('timeLabel', lang);
            $('stopsLabel').textContent = translate('stopsLabel', lang);
            $('startRouteBtn').textContent = translate('startRouteBtn', lang);
            $('startFromMyLocationBtn').textContent = translate('startFromMyLocation', lang);

            // Navigation panel
            $('navPanelTitle').textContent = translate('navPanelTitle', lang);
            $('voiceBtn').textContent = state.voiceEnabled ? translate('voiceOff', lang) : translate('voiceOn', lang);

            // Download panel
            $('downloadPanelTitle').textContent = translate('downloadPanelTitle', lang);
            $('downloadAllBtn').textContent = translate('downloadAll', lang);

            // Weather panel
            $('weatherPanelTitle').textContent = translate('weatherPanelTitle', lang);

            // Emergency panel
            $('emergencyPanelTitle').textContent = translate('emergencyPanelTitle', lang);
            const safetyTips = $('emergencyPanel').querySelector('.safety-tips h4');
            if (safetyTips) safetyTips.textContent = translate('safetyTips', lang);

            // Share modal
            $('shareModalTitle').textContent = translate('shareModalTitle', lang);

            // Details modal
            $('addStopBtn').textContent = translate('addStopBtn', lang);
            $('addDestBtn').textContent = translate('addDestBtn', lang);
            $('routeFromMeBtn').textContent = translate('routeFromMeBtn', lang);
            $('continueRouteBtn').textContent = translate('continueRouteBtn', lang);
            $('closeDetailsBtn').textContent = translate('closeDetailsBtn', lang);
            $('difficultyLabel').textContent = translate('difficultyLabel', lang);
            $('durationLabel').textContent = translate('durationLabel', lang);
            $('distanceLabel').textContent = translate('distanceLabel', lang);
            $('elevationLabel').textContent = translate('elevationLabel', lang);

            // Loading text
            $('loadingText').textContent = translate('loading', lang);

            // Offline indicator
            $('offlineIndicator').textContent = state.isOnline ? translate('online', lang) : translate('offline', lang);

            // Update categories
            if (state.places.length > 0) {
                renderCategories();
                updateSelectedCategoriesSummary();
            }

            // Update route panel if open
            updateRoutePanel();

            // Update details if open
            if (state.detailsPlace) {
                openDetails(state.detailsPlace);
            }

            // Update weather panel if open
            if ($('weatherPanel').style.display === 'flex') {
                updateWeatherPanel();
            }
        }

        function updateLandingPage(lang) {
            $('welcomeTitle').textContent = translate('welcomeTitle', lang);
            $('welcomeText').textContent = translate('welcomeText', lang);
            $('continueBtn').textContent = translate('continue', lang);
        }

        // ===== THEME MANAGEMENT =====
        function setTheme(theme) {
            state.theme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('appTheme', theme);

            // Update theme toggle button
            $('themeToggle').textContent = theme === 'dark' ? '☀️' : '🌙';

            // Update landing page theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === theme) {
                    btn.classList.add('active');
                }
            });

            // Update map theme if needed
            if (state.map) {
                updateMapTheme();
            }
        }

        function updateMapTheme() {
            if (!state.map) return;

            // Store current route before style change
            const currentRoute = state.currentRoute;
            const currentPoints = [...state.routePoints];
            const currentProfile = state.currentProfile;

            // Get appropriate style URL based on theme and layer
            let styleUrl;
            if (state.currentLayer === 'satellite') {
                styleUrl = `https://api.maptiler.com/maps/satellite/style.json?key=${MAPTILER_KEY}`;
            } else if (state.currentLayer === 'hybrid') {
                styleUrl = `https://api.maptiler.com/maps/hybrid/style.json?key=${MAPTILER_KEY}`;
            } else {
                // Use light/dark street maps based on theme
                styleUrl = state.theme === 'dark'
                    ? `https://api.maptiler.com/maps/basic-v2-dark/style.json?key=${MAPTILER_KEY}`
                    : `https://api.maptiler.com/maps/basic-v2/style.json?key=${MAPTILER_KEY}`;
            }

            // Set the new style
            state.map.setStyle(styleUrl);

            // When style loads, restore everything
            state.map.once('styledata', () => {
                console.log('Theme/style changed, restoring state');

                // Wait for map to be fully ready
                state.map.once('idle', () => {
                    setTimeout(() => {
                        // Re-add markers
                        if (state.places.length > 0) {
                            markersInitialized = false;
                            placeMarkers(state.places);
                        }

                        // Restore route after style change
                        if (currentRoute && currentPoints.length >= 2) {
                            setTimeout(() => {
                                const inaccessibleSections = findInaccessibleSections(currentPoints, currentProfile);
                                drawRoute(currentRoute.points, inaccessibleSections);
                                createRouteArrowIcon();
                            }, 1500);
                        }
                    }, 1000);
                });
            });
        }

        // ===== LANDING SCREEN =====
        function enterApp() {
            state.language = $('languageSelect').value;
            localStorage.setItem('appLanguage', state.language);
            $('landing-overlay').classList.add('hidden');
            updateAllTranslations();
            setTimeout(() => {
                if (state.map) state.map.resize();
                $('loading').classList.add('hidden');
                setTimeout(() => {
                    $('loading').style.display = 'none';
                }, 500);
            }, 300);
        }

        // ===== MAP INITIALIZATION WITH ROUTE PERSISTENCE =====
        function initMap() {
            console.log('Initializing map, maplibregl available:', typeof maplibregl);

            if (typeof maplibregl === 'undefined') {
                console.error('MapLibre GL JS not loaded.');
                $('loadingText').textContent = 'Error: Map library failed to load. Please refresh.';
                return;
            }

            try {
                // Use appropriate style based on theme - UPDATED URL
                const styleUrl = state.theme === 'dark'
                    ? `https://api.maptiler.com/maps/basic-v2-dark/style.json?key=${MAPTILER_KEY}`
                    : `https://api.maptiler.com/maps/basic-v2/style.json?key=${MAPTILER_KEY}`;

                state.map = new maplibregl.Map({
                    container: 'map',
                    style: styleUrl,
                    center: [17.9, 43.6],
                    zoom: 8,
                    attributionControl: false,
                    pitch: 0,
                    bearing: 0,
                    preserveDrawingBuffer: true,
                    maxZoom: 18,
                    minZoom: 6
                });

                state.map.addControl(new maplibregl.NavigationControl({ showCompass: true }), 'top-right');
                state.map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');

                // Create route arrow icon AFTER map loads
                state.map.once('load', () => {
                    console.log('Map loaded successfully');

                    // Wait a bit longer for map to stabilize
                    setTimeout(() => {
                        createRouteArrowIcon();
                    }, 1000);

                    loadPlaces();
                    $('loadingText').textContent = translate('loading');

                    // Initialize offline maps if available
                    initializeOfflineMaps();
                });

                // Handle style changes while preserving routes
                state.map.on('styledata', () => {
                    if (isStyleChanging) return;
                    isStyleChanging = true;

                    console.log('Map style changed');

                    // Reset markers flag since style changed
                    markersInitialized = false;

                    // Wait for style to be fully loaded
                    state.map.once('idle', () => {
                        console.log('Style fully loaded after change');

                        // Longer delay to ensure everything is stable
                        setTimeout(() => {
                            // Recreate the arrow icon
                            createRouteArrowIcon();

                            // Redraw route if exists
                            if (state.currentRoute) {
                                setTimeout(() => {
                                    const inaccessibleSections = findInaccessibleSections(state.routePoints, state.currentProfile);
                                    drawRoute(state.currentRoute.points, inaccessibleSections);
                                }, 1000);
                            }

                            // Re-add markers
                            if (state.places.length > 0) {
                                setTimeout(() => {
                                    placeMarkers(state.places);
                                }, 1500);
                            }

                            isStyleChanging = false;
                        }, 2000);
                    });
                });

                // Handle missing images
                state.map.on('styleimagemissing', (e) => {
                    console.log('Missing image detected:', e.id);
                    if (e.id === 'custom-triangle') {
                        setTimeout(() => {
                            createRouteArrowIcon();
                        }, 500);
                    }
                });

                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                $('loadingText').textContent = 'Error initializing map. Please refresh.';
            }
        }

        // ===== FIXED ROUTE ARROW ICON FUNCTION =====
        function createRouteArrowIcon() {
            if (!state.map) {
                setTimeout(createRouteArrowIcon, 500);
                return;
            }

            // Wait for map to be fully loaded
            if (!state.map.loaded() || !state.map.isStyleLoaded()) {
                setTimeout(createRouteArrowIcon, 500);
                return;
            }

            try {
                // Remove existing image if it exists
                if (state.map.hasImage('custom-triangle')) {
                    state.map.removeImage('custom-triangle');
                }

                const size = 64;
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const context = canvas.getContext('2d');

                if (!context) {
                    console.warn('Could not get canvas context for arrow icon');
                    return;
                }

                // Clear canvas
                context.clearRect(0, 0, size, size);

                // Draw a simple directional arrow
                const color = state.currentProfile === 'driving' ? '#0066ff' :
                    state.currentProfile === 'cycling' ? '#ff7300' : '#00a86b';

                context.fillStyle = color;
                context.beginPath();

                // Draw triangle pointing up
                context.moveTo(size / 2, 10); // Top point
                context.lineTo(size - 10, size - 10); // Bottom right
                context.lineTo(10, size - 10); // Bottom left
                context.closePath();
                context.fill();

                // Add white border for visibility
                context.strokeStyle = '#ffffff';
                context.lineWidth = 2;
                context.stroke();

                // Convert canvas to image
                canvas.toBlob((blob) => {
                    if (!blob) return;

                    const img = new Image();
                    img.onload = () => {
                        try {
                            // Check if map is still loaded and ready
                            if (!state.map || !state.map.loaded() || !state.map.isStyleLoaded()) {
                                console.log('Map not ready yet, retrying...');
                                setTimeout(createRouteArrowIcon, 500);
                                return;
                            }

                            // Add the image to the map - THIS IS THE CRITICAL PART
                            state.map.once('idle', () => {
                                if (!state.map.hasImage('custom-triangle')) {
                                    state.map.addImage('custom-triangle', img);
                                    console.log('Route arrow icon created successfully');
                                    routeIconAttempts = 0;

                                    // Redraw route arrows if needed
                                    if (state.currentRoute && state.routePoints.length >= 2) {
                                        setTimeout(() => {
                                            try {
                                                createRouteArrows(state.currentRoute.points);
                                            } catch (error) {
                                                console.warn('Could not recreate route arrows:', error);
                                            }
                                        }, 500);
                                    }
                                }
                            });
                        } catch (error) {
                            console.error('Error adding route arrow image:', error);
                            routeIconAttempts++;
                            if (routeIconAttempts <= 3) {
                                setTimeout(createRouteArrowIcon, 1000);
                            } else {
                                console.warn('Skipping route arrow icon after multiple attempts');
                            }
                        }
                    };

                    img.onerror = () => {
                        console.error('Failed to load arrow icon image');
                        routeIconAttempts++;
                        if (routeIconAttempts <= 3) {
                            setTimeout(createRouteArrowIcon, 1000);
                        }
                    };

                    img.src = URL.createObjectURL(blob);
                });

            } catch (error) {
                console.error('Error in createRouteArrowIcon:', error);
            }
        }

        // ===== CREATE ROUTE ARROWS FUNCTION =====
        function createRouteArrows(geometry) {
            // Double-check if map exists and is ready
            if (!state.map || !state.map.loaded || !state.map.loaded() || !state.map.isStyleLoaded()) {
                console.log('Map not ready for arrow creation');
                setTimeout(() => createRouteArrows(geometry), 500);
                return;
            }

            if (!state.map.hasImage || !state.map.hasImage('custom-triangle')) {
                console.log('Arrow image not available, creating it first');
                createRouteArrowIcon();
                setTimeout(() => createRouteArrows(geometry), 1000);
                return;
            }

            try {
                // SAFELY remove existing arrow layer if it exists
                try {
                    if (state.map.getLayer && state.map.getLayer('route-arrows')) {
                        state.map.removeLayer('route-arrows');
                    }
                } catch (layerError) {
                    console.log('Could not remove route-arrows layer:', layerError.message);
                }

                try {
                    if (state.map.getSource && state.map.getSource('route-arrows-source')) {
                        state.map.removeSource('route-arrows-source');
                    }
                } catch (sourceError) {
                    console.log('Could not remove route-arrows source:', sourceError.message);
                }

                // Sample points along the route for arrows
                const coordinates = geometry.coordinates;

                // Check if we have valid coordinates
                if (!coordinates || coordinates.length < 2) {
                    console.log('Not enough coordinates for arrows');
                    return;
                }

                const arrowCoordinates = [];
                const arrowSpacing = 100; // meters between arrows

                for (let i = 0; i < coordinates.length - 1; i++) {
                    const from = coordinates[i];
                    const to = coordinates[i + 1];

                    // Validate coordinates
                    if (!from || !to || from.length < 2 || to.length < 2) {
                        continue;
                    }

                    const distance = turf.distance(turf.point(from), turf.point(to), { units: 'meters' });

                    // Add arrows along this segment
                    const numArrows = Math.floor(distance / arrowSpacing);
                    if (numArrows > 0) {
                        for (let j = 0; j < numArrows; j++) {
                            const ratio = j / numArrows;
                            const interpolated = turf.along(
                                turf.lineString([from, to]),
                                distance * ratio,
                                { units: 'meters' }
                            ).geometry.coordinates;

                            arrowCoordinates.push({
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: interpolated
                                },
                                properties: {
                                    bearing: calculateBearing(interpolated, coordinates)
                                }
                            });
                        }
                    }
                }

                if (arrowCoordinates.length === 0) {
                    console.log('No arrow coordinates generated');
                    return;
                }

                // Add arrow source
                try {
                    state.map.addSource('route-arrows-source', {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: arrowCoordinates
                        }
                    });
                } catch (sourceAddError) {
                    console.error('Error adding arrow source:', sourceAddError);
                    return;
                }

                // Add arrow layer
                try {
                    state.map.addLayer({
                        id: 'route-arrows',
                        type: 'symbol',
                        source: 'route-arrows-source',
                        layout: {
                            'icon-image': 'custom-triangle',
                            'icon-size': 0.7,
                            'icon-rotate': ['get', 'bearing'],
                            'icon-allow-overlap': true,
                            'icon-ignore-placement': true
                        },
                        paint: {
                            'icon-opacity': 0.8
                        }
                    });

                    console.log('Route arrows created successfully with ' + arrowCoordinates.length + ' arrows');
                } catch (layerAddError) {
                    console.error('Error adding arrow layer:', layerAddError);
                    // Clean up the source if layer creation failed
                    try {
                        if (state.map.getSource('route-arrows-source')) {
                            state.map.removeSource('route-arrows-source');
                        }
                    } catch (cleanupError) {
                        // Ignore cleanup errors
                    }
                }

            } catch (error) {
                console.error('Error creating route arrows:', error);
            }
        }


        // ===== CALCULATE BEARING FUNCTION =====
        function calculateBearing(point, coordinates) {
            const pointIndex = coordinates.findIndex(coord =>
                Math.abs(coord[0] - point[0]) < 0.00001 &&
                Math.abs(coord[1] - point[1]) < 0.00001
            );

            if (pointIndex < 0 || pointIndex >= coordinates.length - 1) return 0;

            const from = coordinates[pointIndex];
            const to = coordinates[pointIndex + 1];

            const y = Math.sin(to[0] - from[0]) * Math.cos(to[1]);
            const x = Math.cos(from[1]) * Math.sin(to[1]) -
                Math.sin(from[1]) * Math.cos(to[1]) * Math.cos(to[0] - from[0]);
            let bearing = Math.atan2(y, x) * (180 / Math.PI);
            bearing = (bearing + 360) % 360;

            return bearing;
        }

        // ===== DATA LOADING =====
        async function loadPlaces() {
            try {
                // Try to load from cache first
                const cached = localStorage.getItem('places_cache');
                if (cached) {
                    state.places = JSON.parse(cached);
                    console.log('Loaded places from cache:', state.places.length);
                } else {
                    // Load from network
                    const response = await fetch('places.json');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    let text = await response.text();
                    const jsonStart = text.indexOf('[');
                    const jsonEnd = text.lastIndexOf(']') + 1;
                    if (jsonStart !== -1 && jsonEnd > jsonStart) text = text.substring(jsonStart, jsonEnd);
                    state.places = JSON.parse(text);
                    console.log('Loaded places from network:', state.places.length);

                    // Cache for offline use
                    localStorage.setItem('places_cache', JSON.stringify(state.places));
                }

                // Process places
                state.places.forEach(place => {
                    if (!place.access) {
                        if (['hiking', 'mtb', 'extreme', 'spring', 'waterfall'].includes(place.cat)) {
                            place.access = 'foot';
                        } else if (place.cat === 'ski') {
                            place.access = 'mixed';
                        } else {
                            place.access = 'car';
                        }
                    }

                    // Add difficulty if not present
                    if (!place.difficulty) {
                        if (place.cat === 'hiking' || place.cat === 'extreme') {
                            place.difficulty = 'medium';
                        } else if (place.cat === 'mtb') {
                            place.difficulty = 'hard';
                        } else {
                            place.difficulty = 'easy';
                        }
                    }

                    // Add duration if not present
                    if (!place.duration) {
                        place.duration = Math.floor(Math.random() * 4) + 1; // 1-4 hours
                    }

                    // Add distance if not present
                    if (!place.distance) {
                        place.distance = Math.floor(Math.random() * 10) + 2; // 2-12 km
                    }

                    // Add elevation if not present
                    if (!place.elevation) {
                        place.elevation = Math.floor(Math.random() * 1000) + 100; // 100-1100 m
                    }

                    // Ensure coordinates are numbers
                    place.lat = parseFloat(place.lat);
                    place.lon = parseFloat(place.lon);
                });

                renderCategories();
                renderPlaces(state.places);
                placeMarkers(state.places);

            } catch (error) {
                console.error('Error loading places:', error);
                state.places = [];
                renderCategories();
                renderPlaces(state.places);
            }
        }

        // ===== MULTI-SELECT CATEGORIES =====
        function renderCategories() {
            const categoryBar = $('categoryBar');
            categoryBar.innerHTML = '';

            // Create "All" button
            const allBtn = create('button', 'category-btn');
            if (state.selectedCategories.has('all')) {
                allBtn.classList.add('active');
            }
            allBtn.innerHTML = `${translate('categories.all')} <span class="checkmark">✓</span>`;
            allBtn.onclick = () => toggleCategory('all');
            categoryBar.appendChild(allBtn);

            // Get unique categories
            const categories = [...new Set(state.places.map(p => p.cat))].sort();
            categories.forEach(cat => {
                let displayCat = cat;
                if (cat === 'historical') displayCat = 'historic';
                if (cat === 'nature-park') displayCat = 'national_park';

                const count = state.places.filter(p => p.cat === cat).length;
                const btn = create('button', 'category-btn');
                if (state.selectedCategories.has(cat)) {
                    btn.classList.add('active');
                }
                btn.innerHTML = `${translate(`categories.${displayCat}`)} (${count}) <span class="checkmark">✓</span>`;
                btn.onclick = () => toggleCategory(cat);
                categoryBar.appendChild(btn);
            });

            updateSelectedCategoriesSummary();
        }

        function toggleCategory(category) {
            if (category === 'all') {
                if (state.selectedCategories.has('all')) {
                    state.selectedCategories.clear();
                } else {
                    state.selectedCategories.clear();
                    state.selectedCategories.add('all');
                }
            } else {
                state.selectedCategories.delete('all');
                if (state.selectedCategories.has(category)) {
                    state.selectedCategories.delete(category);
                    if (state.selectedCategories.size === 0) {
                        state.selectedCategories.add('all');
                    }
                } else {
                    state.selectedCategories.add(category);
                }
            }

            renderCategories();
            filterPlacesByCategories();
            updateSelectedCategoriesSummary();
        }

        function clearAllCategories() {
            state.selectedCategories.clear();
            state.selectedCategories.add('all');
            renderCategories();
            filterPlacesByCategories();
            updateSelectedCategoriesSummary();
        }

        function updateSelectedCategoriesSummary() {
            const count = state.selectedCategories.size;
            let text;
            if (count === 1 && state.selectedCategories.has('all')) {
                text = translate('allCategories');
            } else if (count === 1) {
                text = `${translate('selectedCategories')} ${count} ${translate('categoryText')}`;
            } else {
                text = `${translate('selectedCategories')} ${count} ${translate('categoriesText')}`;
            }
            $('selectedCategoriesText').textContent = text;
        }

        function filterPlacesByCategories() {
            const hasAll = state.selectedCategories.has('all');
            const filteredPlaces = state.places.filter(place => {
                return hasAll || state.selectedCategories.has(place.cat);
            });

            renderPlaces(filteredPlaces);

            // Update marker visibility
            state.markers.forEach(marker => {
                const place = marker._place;
                const el = marker.getElement();
                if (place && el) {
                    const shouldShow = hasAll || state.selectedCategories.has(place.cat);
                    el.style.display = shouldShow ? 'block' : 'none';

                    if (marker.getPopup() && marker.getPopup().isOpen() && !shouldShow) {
                        marker.togglePopup();
                    }
                }
            });
        }

        // ===== MARKERS WITH DIFFICULTY COLORS =====
        function placeMarkers(places) {
            if (markersInitialized) {
                console.log('Markers already initialized, updating visibility...');
                return;
            }

            // Clear existing markers
            state.markers.forEach(marker => marker.remove());
            state.markers = [];

            places.forEach(place => {
                const lat = parseFloat(place.lat);
                const lon = parseFloat(place.lon);
                if (isNaN(lat) || isNaN(lon)) {
                    console.warn(`Invalid coordinates for place: ${place.title?.en || place.title}`, place);
                    return;
                }

                const placeId = `${lat}-${lon}-${place.title?.en || place.title}`.replace(/\s+/g, '-');

                const el = document.createElement('div');
                el.className = 'place-marker';
                el.id = `marker-${placeId}`;
                el.style.position = 'absolute';
                el.style.willChange = 'transform';

                const inner = document.createElement('div');
                inner.className = 'place-marker-inner';

                // Set color based on difficulty
                switch (place.difficulty) {
                    case 'easy': inner.classList.add('marker-easy'); break;
                    case 'medium': inner.classList.add('marker-medium'); break;
                    case 'hard': inner.classList.add('marker-hard'); break;
                    case 'extreme': inner.classList.add('marker-extreme'); break;
                    default: inner.style.background = '#ff7300';
                }

                el.appendChild(inner);

                const marker = new maplibregl.Marker({
                    element: el,
                    anchor: 'center'
                })
                    .setLngLat([lon, lat])
                    .addTo(state.map);

                marker._place = place;
                marker._placeId = placeId;

                // Add popup
                const title = place.title?.[state.language] || place.title?.en || place.title;
                const access = getAccessInfo(place.access);
                const difficulty = translate(`difficulty${place.difficulty.charAt(0).toUpperCase() + place.difficulty.slice(1)}`);

                const popup = new maplibregl.Popup({
                    offset: 25,
                    className: 'custom-popup',
                    maxWidth: '280px'
                }).setHTML(`
                            <div style="padding: 5px;">
                                <strong>${title}</strong><br>
                                <small style="color: var(--text-tertiary);">${access} • ${difficulty}</small>
                                <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 5px;">
                                    <a href="#" onclick="addAsStopFromPopup(${lat}, ${lon}, '${title.replace(/'/g, "\\'")}')"
                                       style="display: block; padding: 10px 15px; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; text-decoration: none; color: var(--text-primary); text-align: center; font-weight: 500;">
                                        🛑 ${translate('addStopBtn')}
                                    </a>
                                    <a href="#" onclick="addAsDestinationFromPopup(${lat}, ${lon}, '${title.replace(/'/g, "\\'")}')"
                                       style="display: block; padding: 10px 15px; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; text-decoration: none; color: var(--text-primary); text-align: center; font-weight: 500;">
                                        🎯 ${translate('addDestBtn')}
                                    </a>
                                    <a href="#" onclick="createRouteFromLastToPopup(${lat}, ${lon}, '${title.replace(/'/g, "\\'")}')"
                                       style="display: block; padding: 10px 15px; background-color: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; text-decoration: none; color: var(--text-primary); text-align: center; font-weight: 500;">
                                        ➕ ${translate('continueRouteBtn').replace('➕ ', '')}
                                    </a>
                                </div>
                            </div>
                        `);

                marker.setPopup(popup);

                // Add click event to open details
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openDetails(place);
                });

                state.markers.push(marker);
            });

            markersInitialized = true;
            console.log(`Placed ${state.markers.length} markers on map`);
        }

        // ===== LOCATION LIST WITH WEATHER =====
        function renderPlaces(places) {
            const list = $('locationList');
            list.innerHTML = '';

            if (places.length === 0) {
                const emptyMsg = create('div');
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.padding = '40px 20px';
                emptyMsg.style.color = 'var(--text-tertiary)';
                emptyMsg.textContent = 'No locations match selected categories';
                list.appendChild(emptyMsg);
                return;
            }

            places.forEach(place => {
                const title = place.title?.[state.language] || place.title?.en || place.title;
                const cat = place.cat;
                const access = place.access || 'car';
                const difficulty = place.difficulty || 'easy';
                const weather = getRandomWeather(); // Simulated weather

                const item = create('div', 'location-item');
                item.onclick = () => {
                    centerOnPlace(place);
                    openDetails(place);
                };

                const info = create('div', 'location-info');

                const titleEl = create('div', 'location-title');
                titleEl.textContent = title;
                info.appendChild(titleEl);

                const catEl = create('div', 'location-category');
                let displayCat = cat;
                if (cat === 'historical') displayCat = 'historic';
                if (cat === 'nature-park') displayCat = 'national_park';
                catEl.textContent = translate(`categories.${displayCat}`);
                info.appendChild(catEl);

                const accessEl = create('div', 'location-access');
                accessEl.textContent = getAccessInfo(access);
                info.appendChild(accessEl);

                const difficultyEl = create('span', `location-difficulty difficulty-${difficulty}`);
                difficultyEl.textContent = translate(`difficulty${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`);
                info.appendChild(difficultyEl);

                const weatherEl = create('div', 'location-weather');
                weatherEl.innerHTML = `<span class="weather-icon">${weather.icon}</span> ${weather.temp}°C`;
                info.appendChild(weatherEl);

                const action = create('button', 'location-action');
                action.innerHTML = 'ℹ';
                action.onclick = (e) => {
                    e.stopPropagation();
                    openDetails(place);
                };

                item.appendChild(info);
                item.appendChild(action);
                list.appendChild(item);
            });
        }

        function getRandomWeather() {
            const weatherTypes = [
                { icon: '☀️', temp: Math.floor(Math.random() * 10) + 20 }, // 20-30°C
                { icon: '⛅', temp: Math.floor(Math.random() * 8) + 15 },  // 15-23°C
                { icon: '🌧️', temp: Math.floor(Math.random() * 6) + 10 },  // 10-16°C
                { icon: '❄️', temp: Math.floor(Math.random() * 5) + 0 }    // 0-5°C
            ];
            return weatherTypes[Math.floor(Math.random() * weatherTypes.length)];
        }

        function getAccessInfo(accessType) {
            switch (accessType) {
                case 'foot': return translate('footAccess');
                case 'car': return translate('carAccess');
                case 'bike': return translate('bikeAccess');
                case 'mixed': return translate('mixedAccess');
                default: return translate('carAccess');
            }
        }

        // ===== LOCATION SERVICES =====
        function getMyLocation() {
            if (!navigator.geolocation) {
                alert(translate('noLocation'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    if (!isValidCoordinate(lat, lon)) {
                        alert('Received invalid location data.');
                        return;
                    }

                    state.myLocation = { lat, lon, accuracy: position.coords.accuracy };
                    updateMyLocationMarker(lat, lon);

                    const zoomLevel = position.coords.accuracy < 50 ? 16 : 14;
                    state.map.flyTo({
                        center: [lon, lat],
                        zoom: zoomLevel,
                        duration: 1000
                    });
                },
                error => {
                    console.error('Geolocation error:', error);
                    alert('Unable to get location. Please enable location services.');
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 30000,
                    timeout: 15000
                }
            );
        }

        function updateMyLocationMarker(lat, lon) {
            if (!state.map) return;

            if (state.myLocationMarker) {
                state.myLocationMarker.remove();
            }

            const el = document.createElement('div');
            el.className = 'my-location-marker';
            el.title = 'Click to start route from here';

            const inner = document.createElement('div');
            inner.className = 'my-location-marker-inner';
            el.appendChild(inner);

            el.addEventListener('click', (e) => {
                e.stopPropagation();
                setMyLocationAsStart();
            });

            state.myLocationMarker = new maplibregl.Marker({
                element: el,
                anchor: 'center'
            })
                .setLngLat([lon, lat])
                .addTo(state.map);
        }

        function isValidCoordinate(lat, lon) {
            return !isNaN(lat) && !isNaN(lon) &&
                lat >= -90 && lat <= 90 &&
                lon >= -180 && lon <= 180;
        }

        // ===== ROUTE MANAGEMENT WITH IMPROVED CAR ROUTING =====
        function canAccessWithProfile(placeAccess, profile) {
            if (profile === 'foot') return true;
            if (profile === 'driving' && (placeAccess === 'foot' || placeAccess === 'mixed')) return false;
            if (profile === 'cycling' && placeAccess === 'foot') return false;
            return true;
        }

        function findInaccessibleSections(points, profile) {
            const inaccessibleSections = [];

            // Only apply to driving profile
            if (profile !== 'driving') {
                return inaccessibleSections;
            }

            if (points.length < 2) {
                return inaccessibleSections;
            }

            // Check if destination has foot/mixed access
            const destination = points[points.length - 1];
            const isDestinationInaccessible = destination.access &&
                (destination.access === 'foot' || destination.access === 'mixed');

            if (!isDestinationInaccessible) {
                return inaccessibleSections; // Destination is car-accessible
            }

            // Find the last car-accessible waypoint before the destination
            let lastCarAccessibleIndex = -1;

            for (let i = points.length - 2; i >= 0; i--) { // Start from second last point
                const point = points[i];

                // Check if this point is accessible by car
                const isAccessible = !point.access ||
                    (point.access !== 'foot' && point.access !== 'mixed');

                if (isAccessible) {
                    lastCarAccessibleIndex = i;
                    break;
                }
            }

            // If we found a car-accessible point
            if (lastCarAccessibleIndex >= 0) {
                const startPoint = points[lastCarAccessibleIndex];
                const endPoint = destination;

                inaccessibleSections.push({
                    type: 'LineString',
                    coordinates: [
                        [startPoint.lon, startPoint.lat],
                        [endPoint.lon, endPoint.lat]
                    ],
                    properties: {
                        description: 'Walking section from last car-accessible point'
                    }
                });
            }
            // If no car-accessible points (starting from foot/mixed location)
            else {
                const startPoint = points[0];
                const endPoint = destination;

                // Only show if start and end are different
                if (startPoint !== endPoint) {
                    inaccessibleSections.push({
                        type: 'LineString',
                        coordinates: [
                            [startPoint.lon, startPoint.lat],
                            [endPoint.lon, endPoint.lat]
                        ],
                        properties: {
                            description: 'Walking-only route'
                        }
                    });
                }
            }

            return inaccessibleSections;
        }

        function drawRoute(geometry, inaccessibleSections = []) {
            if (!state.map || !state.map.getStyle()) return;

            try {
                // Remove existing route layers
                removeRouteLayers();

                // Add route line source
                routeSourceId = 'route-line-' + Date.now();
                state.map.addSource(routeSourceId, {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: geometry
                    }
                });

                // Add route line layer
                routeLayerId = 'route-line-layer-' + Date.now();
                state.map.addLayer({
                    id: routeLayerId,
                    type: 'line',
                    source: routeSourceId,
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': state.currentProfile === 'driving' ? '#0066ff' : '#ff7300',
                        'line-width': 6,
                        'line-opacity': 0.8
                    }
                });


                // Add dashed lines for inaccessible sections
                inaccessibleSections.forEach((section, index) => {
                    const dashedSourceId = `route-dashed-${Date.now()}-${index}`;
                    const dashedLayerId = `route-dashed-layer-${Date.now()}-${index}`;

                    state.map.addSource(dashedSourceId, {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            properties: section.properties || {},
                            geometry: section
                        }
                    });

                    state.map.addLayer({
                        id: dashedLayerId,
                        type: 'line',
                        source: dashedSourceId,
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': '#ff3b30',
                            'line-width': 4,
                            'line-opacity': 0.8,
                            'line-dasharray': [2, 3], // Better spaced dots
                            'line-gap-width': 1
                        }
                    });

                    state.routeDashedLines.push({ sourceId: dashedSourceId, layerId: dashedLayerId });
                });

                // Wait for map to be ready, then add arrows
                setTimeout(() => {
                    if (state.map && state.map.loaded()) {
                        createRouteArrows(geometry);
                    }
                }, 100);

                // Fit map to route bounds
                try {
                    const bounds = geometry.coordinates.reduce((bounds, coord) => {
                        return bounds.extend(coord);
                    }, new maplibregl.LngLatBounds(geometry.coordinates[0], geometry.coordinates[0]));

                    state.map.fitBounds(bounds, {
                        padding: 100,
                        duration: 1000,
                        maxZoom: 16
                    });
                } catch (boundsError) {
                    console.warn('Could not fit bounds:', boundsError);
                }

                console.log('Route drawn successfully');
            } catch (error) {
                console.error('Error drawing route:', error);
            }
        }

        function removeRouteLayers() {
            if (!state.map) return;

            // Remove main route layer safely
            if (routeLayerId) {
                try {
                    if (state.map.getLayer && state.map.getLayer(routeLayerId)) {
                        state.map.removeLayer(routeLayerId);
                    }
                } catch (e) {
                    // Ignore errors
                }

                try {
                    if (state.map.getSource && state.map.getSource(routeSourceId)) {
                        state.map.removeSource(routeSourceId);
                    }
                } catch (e) {
                    // Ignore errors
                }
            }

            // Remove dashed lines safely
            state.routeDashedLines.forEach((line) => {
                try {
                    if (state.map.getLayer && state.map.getLayer(line.layerId)) {
                        state.map.removeLayer(line.layerId);
                    }
                } catch (e) {
                    // Ignore
                }

                try {
                    if (state.map.getSource && state.map.getSource(line.sourceId)) {
                        state.map.removeSource(line.sourceId);
                    }
                } catch (e) {
                    // Ignore
                }
            });
            state.routeDashedLines = [];

            // Remove arrows safely
            try {
                if (state.map.getLayer && state.map.getLayer('route-arrows')) {
                    state.map.removeLayer('route-arrows');
                }
            } catch (e) {
                // Ignore
            }

            try {
                if (state.map.getSource && state.map.getSource('route-arrows-source')) {
                    state.map.removeSource('route-arrows-source');
                }
            } catch (e) {
                // Ignore
            }
        }

        // ===== ROUTE CALCULATION WITH IMPROVED CAR ROUTING =====

        function selectBestRoute(routes, profile) {
            if (routes.length === 1) return routes[0];

            // Sort by duration (fastest first)
            return routes.sort((a, b) => a.time - b.time)[0];
        }

        function calculateRouteWithThrottle() {
            const now = Date.now();
            if (now - lastRouteRequest < MIN_REQUEST_INTERVAL) {
                // If called too soon, schedule for later
                clearTimeout(routeCalculationTimeout);
                routeCalculationTimeout = setTimeout(calculateRoute, MIN_REQUEST_INTERVAL - (now - lastRouteRequest));
                return;
            }

            lastRouteRequest = now;
            calculateRoute();
        }

        async function calculateRoute() {
            if (state.routePoints.length < 2) return;

            // Show loading indicator
            $('loadingText').textContent = 'Calculating optimal route...';
            $('loading').style.display = 'flex';
            $('loading').classList.remove('hidden');

            // Filter out invalid points
            const validPoints = state.routePoints.filter(p =>
                !isNaN(p.lat) && !isNaN(p.lon) &&
                isValidCoordinate(p.lat, p.lon)
            );

            if (validPoints.length < 2) {
                $('loading').classList.add('hidden');
                alert('Please add valid waypoints');
                return;
            }

            // GraphHopper free tier limits
            let pointsToUse = validPoints;
            if (validPoints.length > 5) {
                alert(`GraphHopper free tier only supports up to 5 waypoints. Using first, last, and 3 middle points.`);
                pointsToUse = [validPoints[0]];
                const middlePointsCount = Math.min(3, validPoints.length - 2);
                if (middlePointsCount > 0) {
                    const step = (validPoints.length - 2) / (middlePointsCount + 1);
                    for (let i = 1; i <= middlePointsCount; i++) {
                        const index = Math.floor(i * step) + 1;
                        if (index < validPoints.length - 1) {
                            pointsToUse.push(validPoints[index]);
                        }
                    }
                }
                pointsToUse.push(validPoints[validPoints.length - 1]);
                showSimplifiedRouteNotice(pointsToUse.length, validPoints.length);
            }

            const coordinates = pointsToUse.map(p => [p.lon, p.lat]);

            try {
                const profile = state.currentProfile === 'driving' ? 'car' :
                    state.currentProfile === 'cycling' ? 'bike' : 'foot';

                // Enhanced API parameters for better accuracy
                const url = `https://graphhopper.com/api/1/route?key=${GH_KEY}`;

                const requestBody = {
                    points: coordinates,
                    profile: profile,
                    instructions: true,
                    elevation: true,
                    locale: state.language,
                    points_encoded: false,
                    optimize: false
                };

                console.log('Requesting route with parameters:', requestBody);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('GraphHopper API error:', errorText);
                    throw new Error('Route calculation failed');
                }

                const data = await response.json();
                console.log('Route API response:', data);

                if (!data.paths || data.paths.length === 0) {
                    throw new Error('No route found');
                }

                // Choose the best route
                const bestRoute = selectBestRoute(data.paths, profile);

                // Store route data
                state.currentRoute = {
                    points: {
                        type: 'LineString',
                        coordinates: bestRoute.points.coordinates
                    },
                    distance: bestRoute.distance,
                    duration: bestRoute.time / 1000, // Convert to seconds
                    ascent: bestRoute.ascend || 0,
                    descent: bestRoute.descend || 0
                };

                // Extract detailed instructions
                state.instructions = bestRoute.instructions.map((instruction, index) => ({
                    id: index,
                    text: instruction.text,
                    distance: instruction.distance,
                    time: instruction.time / 1000,
                    interval: instruction.interval
                }));

                // Check for inaccessible sections
                const inaccessibleSections = findInaccessibleSections(pointsToUse, profile);

                // Draw route on map
                drawRoute(state.currentRoute.points, inaccessibleSections);
                updateRoutePanel();
                toggleRoutePanel();

                // Show extended navigation buttons
                $('extendedNav').style.display = 'flex';

            } catch (error) {
                console.error('Error calculating route:', error);

                // Fallback to enhanced route
                drawEnhancedFallbackRoute(coordinates, pointsToUse);
                alert('Using enhanced fallback route. Navigation may not be as accurate.');
            } finally {
                // Hide loading
                $('loading').classList.add('hidden');
                setTimeout(() => {
                    $('loading').style.display = 'none';
                }, 500);
            }
        }

        function estimateTime(distanceKm, profile, fromPoint, toPoint) {
            const baseSpeeds = {
                'driving': 50, // km/h
                'cycling': 15, // km/h
                'foot': 4      // km/h
            };

            const elevationGain = estimateElevationBetween(fromPoint, toPoint);
            let speed = baseSpeeds[profile];

            // Adjust speed based on elevation
            if (elevationGain > 100) {
                speed *= 0.7; // 30% slower for steep climbs
            } else if (elevationGain < -100) {
                speed *= 1.3; // 30% faster for descents
            }

            // Adjust for terrain type
            if (fromPoint.access === 'foot' || toPoint.access === 'foot') {
                speed *= 0.5; // Much slower for foot paths
            }

            return (distanceKm / speed) * 60; // Return minutes
        }

        function estimateElevationBetween(pointA, pointB) {
            if (pointA.elevation && pointB.elevation) {
                return pointB.elevation - pointA.elevation;
            }
            return 0;
        }

        function estimateElevationGain(points) {
            let totalGain = 0;
            for (let i = 1; i < points.length; i++) {
                const gain = estimateElevationBetween(points[i - 1], points[i]);
                if (gain > 0) totalGain += gain;
            }
            return totalGain;
        }

        function generateFallbackInstructions(coordinates, totalDistance) {
            const instructions = [];
            const segmentDistance = totalDistance / 4;

            instructions.push({
                id: 0,
                text: translate('followingRoute'),
                distance: totalDistance * 1000,
                time: state.currentRoute ? state.currentRoute.duration : 0,
                interval: [0, coordinates.length - 1]
            });

            // Add turn instructions at major points
            for (let i = 1; i < coordinates.length - 1; i++) {
                if (i % Math.floor(coordinates.length / 3) === 0) {
                    instructions.push({
                        id: instructions.length,
                        text: `Continue on route (${Math.round(i / coordinates.length * 100)}% complete)`,
                        distance: (totalDistance - (totalDistance * i / coordinates.length)) * 1000,
                        time: state.currentRoute ? state.currentRoute.duration * (1 - i / coordinates.length) : 0,
                        interval: [i, coordinates.length - 1]
                    });
                }
            }

            instructions.push({
                id: instructions.length,
                text: translate('destinationReached'),
                distance: 0,
                time: 0,
                interval: [coordinates.length - 1, coordinates.length - 1]
            });

            return instructions;
        }

        function drawEnhancedFallbackRoute(coordinates, points) {
            // Use turf.js to create a more realistic route
            let totalDistance = 0;
            let totalDuration = 0;
            const routeCoordinates = [];

            for (let i = 0; i < coordinates.length - 1; i++) {
                const from = coordinates[i];
                const to = coordinates[i + 1];
                const distance = turf.distance(turf.point(from), turf.point(to), { units: 'kilometers' });
                totalDistance += distance;

                // Estimate time based on profile and terrain
                const timeEstimate = estimateTime(distance, state.currentProfile, points[i], points[i + 1]);
                totalDuration += timeEstimate;

                // Add intermediate points for smoother route
                routeCoordinates.push(from);

                // Add some intermediate points for longer segments
                if (distance > 1) { // For segments longer than 1km
                    const numPoints = Math.floor(distance);
                    for (let j = 1; j < numPoints; j++) {
                        const ratio = j / numPoints;
                        const intermediate = [
                            from[0] + (to[0] - from[0]) * ratio,
                            from[1] + (to[1] - from[1]) * ratio
                        ];
                        routeCoordinates.push(intermediate);
                    }
                }
            }

            routeCoordinates.push(coordinates[coordinates.length - 1]);

            const fallbackGeometry = {
                type: 'LineString',
                coordinates: routeCoordinates
            };

            state.currentRoute = {
                points: fallbackGeometry,
                distance: totalDistance * 1000, // Convert to meters
                duration: totalDuration * 60, // Convert to seconds
                ascent: estimateElevationGain(points),
                descent: 0
            };

            state.instructions = generateFallbackInstructions(routeCoordinates, totalDistance);

            const inaccessibleSections = findInaccessibleSections(points, state.currentProfile);
            drawRoute(fallbackGeometry, inaccessibleSections);
            updateRoutePanel();
            toggleRoutePanel();
            $('extendedNav').style.display = 'flex';
        }

        function showSimplifiedRouteNotice(displayedPoints, totalPoints) {
            const waypointList = $('waypointList');
            const notice = document.createElement('div');
            notice.className = 'waypoint-item';
            notice.style.background = 'rgba(255, 215, 0, 0.2)';
            notice.style.border = '1px solid rgba(255, 215, 0, 0.4)';
            notice.innerHTML = `
                        <div style="text-align: center; padding: 10px; width: 100%;">
                            <div style="font-weight: bold; color: #996600; margin-bottom: 5px;">⚠️ Simplified Route</div>
                            <div style="font-size: 12px; color: var(--text-tertiary);">
                                Showing ${displayedPoints} of ${totalPoints} waypoints due to API limits.<br>
                                The route will connect the main points.
                            </div>
                        </div>
                    `;

            if (waypointList.firstChild) {
                waypointList.insertBefore(notice, waypointList.firstChild);
            } else {
                waypointList.appendChild(notice);
            }

            setTimeout(() => {
                if (notice.parentNode) {
                    notice.style.opacity = '0';
                    notice.style.transition = 'opacity 0.5s';
                    setTimeout(() => {
                        if (notice.parentNode) {
                            notice.parentNode.removeChild(notice);
                        }
                    }, 500);
                }
            }, 5000);
        }

        function updateRoutePanel() {
            $('waypointCount').textContent = state.routePoints.length;

            if (state.routePoints.length >= 4) {
                $('waypointCount').style.color = '#ff7300';
            } else {
                $('waypointCount').style.color = '';
            }

            if (state.currentRoute) {
                $('totalDistance').textContent = `${(state.currentRoute.distance / 1000).toFixed(1)} km`;
                $('totalTime').textContent = `${Math.round(state.currentRoute.duration / 60)} min`;
            } else {
                $('totalDistance').textContent = '0 km';
                $('totalTime').textContent = '0 min';
            }

            const waypointList = $('waypointList');
            waypointList.innerHTML = '';

            if (state.routePoints.length === 0) {
                const emptyMsg = create('div', 'waypoint-item');
                emptyMsg.innerHTML = `
                            <div style="text-align: center; padding: 20px;">
                                <div style="font-size: 48px; margin-bottom: 10px;">📍</div>
                                <div style="font-weight: bold; margin-bottom: 10px;">${translate('routeEmpty')}</div>
                                <div style="color: var(--text-tertiary); margin-bottom: 15px;">${translate('startNavigation')}:</div>
                                <div style="color: var(--text-tertiary); font-size: 14px; line-height: 1.5;">
                                    1. ${translate('startFromMeText')}<br>
                                    2. ${translate('routeText')}<br>
                                    3. ${translate('addStopBtn').replace('🛑 ', '')}
                                </div>
                                <button onclick="setMyLocationAsStart()"
                                        style="margin-top: 15px; padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                    🚀 ${translate('startFromMeText')}
                                </button>
                            </div>
                        `;
                emptyMsg.style.justifyContent = 'center';
                emptyMsg.style.textAlign = 'center';
                waypointList.appendChild(emptyMsg);
                return;
            }

            state.routePoints.forEach((point, index) => {
                const item = create('div', 'waypoint-item');
                item.draggable = true;
                item.dataset.index = index;

                // Highlight inaccessible points
                if (point.access && !canAccessWithProfile(point.access, state.currentProfile)) {
                    item.style.background = 'rgba(255, 100, 100, 0.1)';
                    item.style.border = '1px solid rgba(255, 100, 100, 0.3)';
                }

                // Drag and drop for reordering
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', index);
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    item.style.backgroundColor = 'var(--bg-tertiary)';
                });

                item.addEventListener('dragleave', () => {
                    item.style.backgroundColor = '';
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.style.backgroundColor = '';
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = index;

                    if (fromIndex !== toIndex) {
                        const [movedItem] = state.routePoints.splice(fromIndex, 1);
                        state.routePoints.splice(toIndex, 0, movedItem);

                        updateRoutePanel();
                        if (state.routePoints.length >= 2) {
                            calculateRouteWithThrottle();
                        }
                    }
                });

                const number = create('div', 'waypoint-number');
                number.textContent = index + 1;
                number.style.cursor = 'move';
                number.title = 'Drag to reorder';

                if (point.access && !canAccessWithProfile(point.access, state.currentProfile)) {
                    number.style.background = '#ff3b30';
                    number.title = 'Inaccessible with current transport mode';
                }

                item.appendChild(number);

                const details = create('div', 'waypoint-details');

                const title = create('div', 'waypoint-title');
                title.textContent = point.title || `Waypoint ${index + 1}`;
                details.appendChild(title);

                const access = create('div', 'waypoint-access');
                access.textContent = `${point.lat.toFixed(4)}, ${point.lon.toFixed(4)}`;
                if (point.access) {
                    access.innerHTML += ` • ${getAccessInfo(point.access)}`;
                }
                details.appendChild(access);

                const removeBtn = create('button', 'waypoint-remove');
                removeBtn.innerHTML = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    state.routePoints.splice(index, 1);
                    updateRoutePanel();
                    if (state.routePoints.length >= 2) {
                        calculateRouteWithThrottle();
                    } else {
                        clearRoute();
                    }
                };

                item.appendChild(details);
                item.appendChild(removeBtn);
                waypointList.appendChild(item);
            });
        }

        // ===== ROUTE ACTIONS =====
        function addAsStop() {
            if (!state.detailsPlace) return;

            const place = state.detailsPlace;
            state.routePoints.push({
                lat: parseFloat(place.lat),
                lon: parseFloat(place.lon),
                title: place.title?.[state.language] || place.title?.en || place.title,
                access: place.access
            });

            updateRoutePanel();
            closeDetails();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }
        }

        function addAsDestination() {
            if (!state.detailsPlace) return;

            const place = state.detailsPlace;
            if (state.routePoints.length === 0) {
                if (!state.myLocation) {
                    alert(translate('noLocation'));
                    getMyLocation();
                    return;
                }

                state.routePoints = [
                    {
                        lat: state.myLocation.lat,
                        lon: state.myLocation.lon,
                        title: translate('myLocation')
                    },
                    {
                        lat: parseFloat(place.lat),
                        lon: parseFloat(place.lon),
                        title: place.title?.[state.language] || place.title?.en || place.title,
                        access: place.access
                    }
                ];
            } else {
                state.routePoints.push({
                    lat: parseFloat(place.lat),
                    lon: parseFloat(place.lon),
                    title: place.title?.[state.language] || place.title?.en || place.title,
                    access: place.access
                });
            }

            updateRoutePanel();
            closeDetails();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }
        }

        function startRouteFromMeToHere() {
            if (!state.detailsPlace) return;

            if (!state.myLocation) {
                alert(translate('noLocation'));
                getMyLocation();
                return;
            }

            const place = state.detailsPlace;
            state.routePoints = [
                {
                    lat: state.myLocation.lat,
                    lon: state.myLocation.lon,
                    title: translate('myLocation')
                },
                {
                    lat: parseFloat(place.lat),
                    lon: parseFloat(place.lon),
                    title: place.title?.[state.language] || place.title?.en || place.title,
                    access: place.access
                }
            ];

            updateRoutePanel();
            closeDetails();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }
        }

        function createRouteFromLastToHere() {
            if (!state.detailsPlace) return;

            if (state.routePoints.length === 0) {
                alert('Please create a route first');
                return;
            }

            const place = state.detailsPlace;
            state.routePoints.push({
                lat: parseFloat(place.lat),
                lon: parseFloat(place.lon),
                title: place.title?.[state.language] || place.title?.en || place.title,
                access: place.access
            });

            updateRoutePanel();
            closeDetails();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }
        }

        function setMyLocationAsStart() {
            if (!state.myLocation) {
                alert(translate('noLocation'));
                getMyLocation();
                return;
            }

            state.routePoints = [{
                lat: state.myLocation.lat,
                lon: state.myLocation.lon,
                title: translate('myLocation')
            }];

            updateRoutePanel();
            toggleRoutePanel();
            alert('Your location has been set as the starting point. Now add destinations by clicking on places or the map.');
        }

        function startNavigationFromMyLocation() {
            if (!state.myLocation) {
                alert(translate('noLocation'));
                getMyLocation();
                return;
            }

            if (state.routePoints.length === 0) {
                alert('Please create a route first');
                return;
            }

            const firstPoint = state.routePoints[0];
            const isMyLocationFirst = firstPoint.title === translate('myLocation') ||
                (Math.abs(firstPoint.lat - state.myLocation.lat) < 0.001 &&
                    Math.abs(firstPoint.lon - state.myLocation.lon) < 0.001);

            if (!isMyLocationFirst) {
                state.routePoints.unshift({
                    lat: state.myLocation.lat,
                    lon: state.myLocation.lon,
                    title: translate('myLocation')
                });
            }

            updateRoutePanel();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
                startNavigation();
            }
        }

        function clearRoute() {
            state.routePoints = [];
            state.currentRoute = null;
            state.instructions = [];
            state.currentStep = 0;

            removeRouteLayers();
            updateRoutePanel();
            $('routePanel').style.display = 'none';
            $('extendedNav').style.display = 'none';
            stopNavigation();
        }

        // ===== PANEL MANAGEMENT =====
        function toggleRoutePanel() {
            const panel = $('routePanel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'flex';
                updateRoutePanel();
            }
        }

        function toggleNavPanel() {
            const panel = $('navPanel');
            const btn = $('collapseBtn');

            state.navPanelCollapsed = !state.navPanelCollapsed;

            if (state.navPanelCollapsed) {
                panel.classList.add('collapsed');
                btn.textContent = '▲';
            } else {
                panel.classList.remove('collapsed');
                btn.textContent = '▼';
            }
        }

        function toggleSidebar() {
            const sidebar = $('sidebar');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                state.sidebarVisible = false;
            } else {
                sidebar.classList.add('open');
                state.sidebarVisible = true;
            }
        }

        // ===== NAVIGATION FUNCTIONS =====
        function startNavigation() {
            if (state.routePoints.length < 2) {
                alert('Please add at least 2 waypoints to start navigation');
                return;
            }
            if (!state.currentRoute) {
                calculateRouteWithThrottle();
                return;
            }

            state.isNavigating = true;
            state.navPanelCollapsed = false;
            $('navPanel').classList.remove('collapsed');
            $('collapseBtn').textContent = '▼';
            $('navPanel').style.display = 'flex';
            $('routePanel').style.display = 'none';
            enable3DMode();

            // Start watching user location
            if (navigator.geolocation) {
                state.watchId = navigator.geolocation.watchPosition(
                    position => {
                        updateNavigation(position);
                    },
                    error => {
                        console.warn('Navigation watch error:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 1000,
                        timeout: 5000
                    }
                );
            }

            // Speak first instruction
            if (state.voiceEnabled) {
                speakInstruction(state.instructions[0]?.text || translate('followingRoute'));
            }

            updateStepDisplay();

            // Auto-collapse panel after 5 seconds
            setTimeout(() => {
                if (state.isNavigating && !state.navPanelCollapsed) {
                    toggleNavPanel();
                }
            }, 5000);
        }

        function updateNavigation(position) {
            if (!state.isNavigating || !state.currentRoute) return;

            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;

            if (!isValidCoordinate(userLat, userLon)) return;

            // Update user location marker
            try {
                updateMyLocationMarker(userLat, userLon);
            } catch (error) {
                console.warn('Error updating location marker:', error);
            }

            // Update map view
            if (position.coords.accuracy < 50) {
                state.map.flyTo({
                    center: [userLon, userLat],
                    zoom: calculateDynamicZoom(position.coords.speed),
                    pitch: calculateDynamicPitch(position.coords.speed),
                    bearing: position.coords.heading || state.map.getBearing(),
                    duration: 800
                });
            }

            // Find closest point on route
            const routePoints = state.currentRoute.points.coordinates;
            let closestDistance = Infinity;
            let closestIndex = 0;

            const step = Math.max(1, Math.floor(routePoints.length / 100));
            for (let i = 0; i < routePoints.length; i += step) {
                const [lon, lat] = routePoints[i];
                const distance = turf.distance(
                    turf.point([userLon, userLat]),
                    turf.point([lon, lat]),
                    { units: 'meters' }
                );
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestIndex = i;
                }
            }

            // Update current instruction
            const currentInstruction = findCurrentInstruction(closestIndex);
            if (currentInstruction !== state.currentStep) {
                state.currentStep = currentInstruction;
                updateStepDisplay();

                if (state.voiceEnabled && state.instructions[currentInstruction]) {
                    speakInstruction(state.instructions[currentInstruction].text);
                }
            }

            // Update distance to next turn
            if (state.instructions[state.currentStep]) {
                const distanceToNext = calculateDistanceToNextTurn(closestIndex);
                $('currentDistance').textContent = `${Math.round(distanceToNext)} m`;
            }

            // Check if destination reached
            if (closestDistance < 50 && closestIndex > routePoints.length - 10) {
                if (state.voiceEnabled) speakInstruction(translate('destinationReached'));
                alert('Destination reached!');
                stopNavigation();
            }
        }

        // Add these functions to handle popup actions
        function addAsStopFromPopup(lat, lon, title) {
            state.routePoints.push({
                lat: lat,
                lon: lon,
                title: title
            });
            updateRoutePanel();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }

            state.markers.forEach(marker => {
                if (marker.getPopup() && marker.getPopup().isOpen()) {
                    marker.togglePopup();
                }
            });

            toggleRoutePanel();
        }

        function addAsDestinationFromPopup(lat, lon, title) {
            if (state.routePoints.length === 0) {
                if (!state.myLocation) {
                    alert(translate('noLocation'));
                    getMyLocation();
                    return;
                }

                state.routePoints = [
                    { lat: state.myLocation.lat, lon: state.myLocation.lon, title: translate('myLocation') },
                    { lat: lat, lon: lon, title: title }
                ];
            } else {
                state.routePoints.push({ lat: lat, lon: lon, title: title });
            }

            updateRoutePanel();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }

            state.markers.forEach(marker => {
                if (marker.getPopup() && marker.getPopup().isOpen()) {
                    marker.togglePopup();
                }
            });

            toggleRoutePanel();
        }

        function createRouteFromLastToPopup(lat, lon, title) {
            if (state.routePoints.length === 0) {
                alert('Please create a route first');
                return;
            }

            state.routePoints.push({ lat: lat, lon: lon, title: title });
            updateRoutePanel();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }

            state.markers.forEach(marker => {
                if (marker.getPopup() && marker.getPopup().isOpen()) {
                    marker.togglePopup();
                }
            });

            toggleRoutePanel();
        }

        function calculateDynamicZoom(speed) {
            if (!speed) return 16;
            if (speed > 20) return 14;
            if (speed > 10) return 15;
            if (speed > 5) return 16;
            return 17;
        }

        function calculateDynamicPitch(speed) {
            if (!speed) return 60;
            if (speed > 20) return 45;
            if (speed > 10) return 50;
            if (speed > 5) return 55;
            return 60;
        }

        function findCurrentInstruction(positionIndex) {
            if (!state.instructions.length) return 0;

            for (let i = 0; i < state.instructions.length; i++) {
                if (state.instructions[i].interval &&
                    positionIndex >= state.instructions[i].interval[0] &&
                    positionIndex <= state.instructions[i].interval[1]) {
                    return i;
                }
            }
            return state.currentStep;
        }

        function calculateDistanceToNextTurn(currentIndex) {
            if (!state.instructions[state.currentStep] || !state.currentRoute) return 0;

            const nextInstruction = state.instructions[state.currentStep];
            if (!nextInstruction.interval) return 0;

            const routePoints = state.currentRoute.points.coordinates;
            const nextTurnIndex = nextInstruction.interval[1];

            if (nextTurnIndex <= currentIndex) return 0;

            let distance = 0;
            for (let i = currentIndex; i < nextTurnIndex && i < routePoints.length - 1; i++) {
                const from = routePoints[i];
                const to = routePoints[i + 1];
                distance += turf.distance(turf.point(from), turf.point(to), { units: 'meters' });
            }

            return distance;
        }

        function updateStepDisplay() {
            const stepList = $('stepList');
            stepList.innerHTML = '';

            if (!state.instructions.length) {
                $('currentInstruction').textContent = translate('followingRoute');
                return;
            }

            const currentInstruction = state.instructions[state.currentStep];
            if (currentInstruction) {
                $('currentInstruction').textContent = currentInstruction.text;
            }

            state.instructions.forEach((instruction, index) => {
                const item = create('div', 'step-item');

                const icon = create('div', 'step-icon');
                icon.textContent = index + 1;
                if (index === state.currentStep) {
                    icon.style.background = '#00a86b';
                }
                item.appendChild(icon);

                const content = create('div', 'step-content');

                const main = create('div', 'step-main');
                main.textContent = instruction.text;
                content.appendChild(main);

                const distance = create('div', 'step-dist');
                distance.textContent = `${Math.round(instruction.distance)} m`;
                content.appendChild(distance);

                item.appendChild(content);
                stepList.appendChild(item);
            });
        }

        function stopNavigation() {
            state.isNavigating = false;
            state.navPanelCollapsed = false;
            $('navPanel').style.display = 'none';
            disable3DMode();

            if (state.watchId) {
                navigator.geolocation.clearWatch(state.watchId);
                state.watchId = null;
            }
        }

        // ===== 3D MODE =====
        function enable3DMode() {
            if (state.is3DMode) return;
            state.map.setPitch(60);
            state.map.setBearing(0);
            state.is3DMode = true;
        }

        function disable3DMode() {
            if (!state.is3DMode) return;
            state.map.setPitch(0);
            state.map.setBearing(0);
            state.is3DMode = false;
        }

        // ===== VOICE NAVIGATION =====
        function toggleVoice() {
            state.voiceEnabled = !state.voiceEnabled;
            $('voiceBtn').textContent = state.voiceEnabled ? translate('voiceOff') : translate('voiceOn');
            if (state.voiceEnabled) {
                $('voiceBtn').classList.add('active');
            } else {
                $('voiceBtn').classList.remove('active');
            }

            if (state.voiceEnabled && state.isNavigating && state.instructions[state.currentStep]) {
                speakInstruction(state.instructions[state.currentStep].text);
            }
        }

        function speakInstruction(text) {
            if (!('speechSynthesis' in window)) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = getVoiceLanguage();
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 1;
            speechSynthesis.speak(utterance);
        }

        function getVoiceLanguage() {
            const langMap = {
                'bs': 'hr-HR',
                'en': 'en-US',
                'it': 'it-IT',
                'fr': 'fr-FR',
                'es': 'es-ES',
                'de': 'de-DE'
            };
            return langMap[state.language] || 'en-US';
        }

        // ===== DETAILS MODAL =====
        function openDetails(place) {
            console.log('Opening details for place:', place); // Debug log

            if (!place) {
                console.error('No place data provided');
                return;
            }

            state.detailsPlace = place;

            // Safely get title
            let title = 'No Title';
            if (place.title) {
                if (typeof place.title === 'object' && place.title[state.language]) {
                    title = place.title[state.language];
                } else if (place.title.en) {
                    title = place.title.en;
                } else if (typeof place.title === 'string') {
                    title = place.title;
                }
            }

            // Safely get description
            let desc = 'No description available';
            if (place.desc) {
                if (typeof place.desc === 'object' && place.desc[state.language]) {
                    desc = place.desc[state.language];
                } else if (place.desc.en) {
                    desc = place.desc.en;
                } else if (typeof place.desc === 'string') {
                    desc = place.desc;
                }
            }

            const cat = place.cat || 'unknown';
            const access = place.access || 'car';
            const difficulty = place.difficulty || 'easy';
            const duration = place.duration || 2;
            const distance = place.distance || 5;
            const elevation = place.elevation || 300;

            console.log('Setting details:', { title, cat, access }); // Debug log

            $('detailTitle').textContent = title;

            // Translate category
            let displayCat = cat;
            if (cat === 'historical') displayCat = 'historic';
            if (cat === 'nature-park') displayCat = 'national_park';

            // Make sure the category exists in translations
            const categoryTranslation = translate(`categories.${displayCat}`);
            $('detailCategory').textContent = categoryTranslation || displayCat;

            $('detailDesc').textContent = desc;
            $('detailDifficulty').textContent = translate(`difficulty${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`) || difficulty;
            $('detailDuration').textContent = `${duration} ${translate('durationLabel').toLowerCase() || 'hours'}`;
            $('detailDistance').textContent = `${distance} km`;
            $('detailElevation').textContent = `${elevation} m`;

            // Handle access info
            const accessInfo = $('accessInfo');
            const accessDetails = $('accessDetails');

            if (access === 'foot' || access === 'mixed') {
                accessInfo.style.display = 'block';
                if (access === 'foot') {
                    accessDetails.textContent = 'This location is not directly accessible by car. You need to walk the last part of the route.';
                } else if (access === 'mixed') {
                    accessDetails.textContent = 'This location has mixed access: partially accessible by car, then on foot.';
                }
            } else {
                accessInfo.style.display = 'none';
            }

            // Handle image
            const imageEl = $('detailImage');
            if (place.photo && place.photo.trim() !== '') {
                console.log('Setting image URL:', place.photo); // Debug log
                imageEl.style.backgroundImage = `url(${place.photo})`;
                imageEl.style.backgroundSize = 'cover';
                imageEl.style.backgroundPosition = 'center';
                imageEl.innerHTML = '';
            } else {
                console.log('No image available, using placeholder'); // Debug log
                imageEl.style.backgroundImage = 'none';
                imageEl.style.backgroundColor = 'var(--bg-tertiary)';
                imageEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary); font-size: 48px;">🏔️</div>';
            }

            // Update button text
            $('addStopBtn').textContent = translate('addStopBtn');
            $('addDestBtn').textContent = translate('addDestBtn');
            $('routeFromMeBtn').textContent = translate('routeFromMeBtn');
            $('continueRouteBtn').textContent = translate('continueRouteBtn');
            $('closeDetailsBtn').textContent = translate('closeDetailsBtn');

            // Show the modal
            $('detailsModal').style.display = 'flex';
            console.log('Details modal shown'); // Debug log
        }

        function closeDetails() {
            $('detailsModal').style.display = 'none';
            state.detailsPlace = null;
        }

        // ===== UI FUNCTIONS =====
        function centerOnPlace(place) {
            if (!place) return;
            const lat = parseFloat(place.lat);
            const lon = parseFloat(place.lon);

            if (isNaN(lat) || isNaN(lon)) return;

            state.map.flyTo({
                center: [lon, lat],
                zoom: 14,
                duration: 1000
            });
        }

        // ===== OFFLINE MODE =====
        function initializeOfflineMaps() {
            // Update offline indicator
            updateOfflineIndicator();

            // Listen for online/offline events
            window.addEventListener('online', () => {
                state.isOnline = true;
                updateOfflineIndicator();
            });

            window.addEventListener('offline', () => {
                state.isOnline = false;
                updateOfflineIndicator();
            });

            // Load offline regions
            renderDownloadRegions();
        }

        function updateOfflineIndicator() {
            const indicator = $('offlineIndicator');
            if (state.isOnline) {
                indicator.textContent = translate('online');
                indicator.className = 'offline-indicator online';
            } else {
                indicator.textContent = translate('offline');
                indicator.className = 'offline-indicator offline';
            }
            indicator.style.display = 'block';
        }

        function renderDownloadRegions() {
            const regionList = $('regionList');
            regionList.innerHTML = '';

            const regions = [
                { id: 'sarajevo', name: 'Sarajevo', size: '45 MB', downloaded: state.offlineMaps.sarajevo },
                { id: 'mostar', name: 'Mostar', size: '38 MB', downloaded: state.offlineMaps.mostar },
                { id: 'banja_luka', name: 'Banja Luka', size: '42 MB', downloaded: state.offlineMaps.banja_luka },
                { id: 'trebinje', name: 'Trebinje', size: '35 MB', downloaded: state.offlineMaps.trebinje },
                { id: 'tuzla', name: 'Tuzla', size: '40 MB', downloaded: state.offlineMaps.tuzla },
                { id: 'zenica', name: 'Zenica', size: '37 MB', downloaded: state.offlineMaps.zenica }
            ];

            regions.forEach(region => {
                const regionEl = create('div', 'download-region');
                regionEl.onclick = () => downloadRegion(region.id);

                const name = create('div', 'region-name');
                name.textContent = region.name;

                const size = create('div', 'region-size');
                size.textContent = region.downloaded ? '✅ Preuzeto' : `📥 ${region.size}`;

                regionEl.appendChild(name);
                regionEl.appendChild(size);

                if (region.downloaded) {
                    const progress = create('div', 'download-progress');
                    const progressBar = create('div', 'download-progress-bar');
                    progressBar.style.width = '100%';
                    progress.appendChild(progressBar);
                    regionEl.appendChild(progress);
                }

                regionList.appendChild(regionEl);
            });
        }

        function downloadRegion(regionId) {
            if (!state.isOnline) {
                alert('You need to be online to download maps.');
                return;
            }

            $('downloadStatus').style.display = 'block';
            $('downloadingRegion').textContent = `Preuzimanje ${regionId}...`;

            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                $('downloadProgressText').textContent = `${progress}%`;
                $('downloadProgressBar').style.width = `${progress}%`;

                if (progress >= 100) {
                    clearInterval(interval);
                    state.offlineMaps[regionId] = true;
                    localStorage.setItem('offline_maps', JSON.stringify(state.offlineMaps));
                    renderDownloadRegions();
                    $('downloadStatus').style.display = 'none';
                    alert('Map downloaded successfully!');
                }
            }, 200);
        }

        function downloadAllRegions() {
            const regions = ['sarajevo', 'mostar', 'banja_luka', 'trebinje', 'tuzla', 'zenica'];
            regions.forEach(region => {
                if (!state.offlineMaps[region]) {
                    downloadRegion(region);
                }
            });
        }

        function toggleDownloadPanel() {
            const panel = $('downloadPanel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        // ===== WEATHER INTEGRATION =====
        function updateWeatherPanel() {
            $('currentDesc').textContent = translate('weatherLoading');

            // Simulated weather data (in real app, use Weather API)
            const weatherData = {
                current: {
                    temp: Math.floor(Math.random() * 15) + 15,
                    desc: ['Sunny', 'Cloudy', 'Rainy', 'Snow'][Math.floor(Math.random() * 4)],
                    icon: 'wi-day-sunny'
                },
                forecast: [
                    { day: 'Mon', temp: Math.floor(Math.random() * 15) + 15, icon: 'wi-day-sunny' },
                    { day: 'Tue', temp: Math.floor(Math.random() * 15) + 15, icon: 'wi-day-cloudy' },
                    { day: 'Wed', temp: Math.floor(Math.random() * 15) + 15, icon: 'wi-day-rain' }
                ]
            };

            $('currentTemp').textContent = `${weatherData.current.temp}°C`;
            $('currentDesc').textContent = weatherData.current.desc;
            $('weatherCurrent').querySelector('.weather-icon-large').className = `weather-icon-large wi ${weatherData.current.icon}`;

            const forecast = $('weatherForecast');
            forecast.innerHTML = '';

            weatherData.forecast.forEach(day => {
                const dayEl = create('div', 'weather-day');
                dayEl.innerHTML = `
                            <div class="weather-day-name">${day.day}</div>
                            <div class="weather-day-icon wi ${day.icon}"></div>
                            <div class="weather-day-temp">${day.temp}°C</div>
                        `;
                forecast.appendChild(dayEl);
            });
        }

        function toggleWeatherPanel() {
            const panel = $('weatherPanel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
                if (weatherUpdateInterval) {
                    clearInterval(weatherUpdateInterval);
                    weatherUpdateInterval = null;
                }
            } else {
                panel.style.display = 'flex';
                updateWeatherPanel();
                // Update weather every 5 minutes
                weatherUpdateInterval = setInterval(updateWeatherPanel, 300000);
            }
        }

        // ===== EMERGENCY PANEL =====
        function toggleEmergencyPanel() {
            const panel = $('emergencyPanel');
            panel.style.display = panel.style.display === 'flex' ? 'none' : 'flex';
        }

        // ===== SHARE FUNCTIONALITY =====
        function toggleShareModal() {
            const modal = $('shareModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';

            if (modal.style.display === 'flex') {
                // Generate share URL
                const routeData = {
                    points: state.routePoints,
                    profile: state.currentProfile,
                    language: state.language
                };
                const encoded = btoa(JSON.stringify(routeData));
                $('shareUrl').value = `https://bih-outdoor.app/route/${encoded}`;
            }
        }

        function shareVia(platform) {
            const url = $('shareUrl').value;
            const title = 'Check out my BiH Outdoor route!';

            switch (platform) {
                case 'whatsapp':
                    window.open(`https://wa.me/?text=${encodeURIComponent(title + ' ' + url)}`, '_blank');
                    break;
                case 'facebook':
                    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
                    break;
                case 'twitter':
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(url)}`, '_blank');
                    break;
                case 'copy':
                    copyShareUrl();
                    break;
            }
        }

        function copyShareUrl() {
            const urlInput = $('shareUrl');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('URL copied to clipboard!');
        }

        // ===== POPUP FUNCTIONS =====
        window.addAsStopFromPopup = function (lat, lon, title) {
            state.routePoints.push({
                lat: lat,
                lon: lon,
                title: title
            });

            updateRoutePanel();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }

            state.markers.forEach(marker => {
                if (marker.getPopup() && marker.getPopup().isOpen()) {
                    marker.togglePopup();
                }
            });

            toggleRoutePanel();
        };

        window.addAsDestinationFromPopup = function (lat, lon, title) {
            if (state.routePoints.length === 0) {
                if (!state.myLocation) {
                    alert(translate('noLocation'));
                    getMyLocation();
                    return;
                }

                state.routePoints = [
                    {
                        lat: state.myLocation.lat,
                        lon: state.myLocation.lon,
                        title: translate('myLocation')
                    },
                    {
                        lat: lat,
                        lon: lon,
                        title: title
                    }
                ];
            } else {
                state.routePoints.push({
                    lat: lat,
                    lon: lon,
                    title: title
                });
            }

            updateRoutePanel();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }

            state.markers.forEach(marker => {
                if (marker.getPopup() && marker.getPopup().isOpen()) {
                    marker.togglePopup();
                }
            });

            toggleRoutePanel();
        };

        window.createRouteFromLastToPopup = function (lat, lon, title) {
            if (state.routePoints.length === 0) {
                alert('Please create a route first');
                return;
            }

            state.routePoints.push({
                lat: lat,
                lon: lon,
                title: title
            });

            updateRoutePanel();

            if (state.routePoints.length >= 2) {
                calculateRouteWithThrottle();
            }

            state.markers.forEach(marker => {
                if (marker.getPopup() && marker.getPopup().isOpen()) {
                    marker.togglePopup();
                }
            });

            toggleRoutePanel();
        };

        // ===== INITIALIZATION =====
        function initializeApp() {
            console.log('Initializing app...');

            // Load saved preferences
            const savedTheme = localStorage.getItem('appTheme');
            const savedLanguage = localStorage.getItem('appLanguage');

            if (savedTheme) {
                state.theme = savedTheme;
                setTheme(savedTheme);
            }

            if (savedLanguage) {
                state.language = savedLanguage;
                $('languageSelect').value = savedLanguage;
            }

            // Initialize event listeners
            initializeEventListeners();

            // Initialize map
            initMap();

            // Start offline monitoring
            initializeOfflineMaps();

            // Hide loading screen after 1.5 seconds
            setTimeout(() => {
                $('loading').classList.add('hidden');
                setTimeout(() => {
                    $('loading').style.display = 'none';
                }, 500);
            }, 1500);

            console.log('App initialized successfully with all features');
        }

        // ===== EVENT LISTENERS =====
        function initializeEventListeners() {
            // Add this at the top of your initializeEventListeners function
            let touchStartTime = 0;
            let touchStartX = 0;
            let touchStartY = 0;

            document.addEventListener('touchstart', (e) => {
                touchStartTime = Date.now();
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                startX = touchStartX; // Keep for existing code
                startY = touchStartY;
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                // Let scrolling happen naturally unless we're definitely swiping
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = touchStartX - currentX;
                const diffY = touchStartY - currentY;

                // Only handle horizontal swipes from edge
                const isHorizontalSwipe = Math.abs(diffX) > Math.abs(diffY) * 2;
                const isFromLeftEdge = touchStartX < 30; // Very close to left edge
                const isLargeSwipe = Math.abs(diffX) > 50;

                if (isHorizontalSwipe && isFromLeftEdge && isLargeSwipe && e.cancelable) {
                    e.preventDefault();

                    // Open/close sidebar based on swipe direction
                    if (diffX < -50 && !state.sidebarVisible) { // Swipe right to open
                        toggleSidebar();
                    } else if (diffX > 50 && state.sidebarVisible) { // Swipe left to close
                        toggleSidebar();
                    }
                }
            }, { passive: false });

            document.addEventListener('touchend', (e) => {
                const touchDuration = Date.now() - touchStartTime;
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const diffX = touchStartX - endX;
                const diffY = touchStartY - endY;

                // Quick swipe detection (less than 300ms)
                if (touchDuration < 300 && Math.abs(diffX) > 50 && Math.abs(diffY) < 30) {
                    if (touchStartX < 50) { // From left edge
                        if (diffX < -50 && !state.sidebarVisible) { // Swipe right
                            toggleSidebar();
                        }
                    }
                }
            }, { passive: true });
            // Landing page
            $('continueBtn').addEventListener('click', enterApp);

            // Theme toggles
            $('themeToggle').addEventListener('click', () => {
                setTheme(state.theme === 'light' ? 'dark' : 'light');
            });

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const theme = btn.dataset.theme;
                    setTheme(theme);
                });
            });

            // Language select
            $('languageSelect').addEventListener('change', (e) => {
                state.language = e.target.value;
                updateAllTranslations();
            });

            // Top controls
            document.querySelectorAll('.layer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const layer = btn.dataset.layer;
                    document.querySelectorAll('.layer-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentLayer = layer;
                    updateMapTheme();
                });
            });

            document.querySelectorAll('.prof-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const prof = btn.dataset.prof;
                    document.querySelectorAll('.prof-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentProfile = prof;

                    // Update arrow icon color based on profile
                    createRouteArrowIcon();

                    // Recalculate route if exists
                    if (state.routePoints.length >= 2) {
                        calculateRouteWithThrottle();
                    }
                });
            });

            // Sidebar
            $('openSidebarBtn').addEventListener('click', toggleSidebar);
            $('closeSidebar').addEventListener('click', toggleSidebar);
            $('clearCategoriesBtn').addEventListener('click', clearAllCategories);

            // Bottom navigation
            $('navRoute').addEventListener('click', () => {
                if (state.routePoints.length > 0) {
                    toggleRoutePanel();
                } else {
                    alert('Dodajte barem jednu lokaciju da kreirate rutu.');
                }
            });

            $('navCenter').addEventListener('click', getMyLocation);
            $('navDownload').addEventListener('click', toggleDownloadPanel);
            $('navWeather').addEventListener('click', toggleWeatherPanel);
            $('navEmergency').addEventListener('click', toggleEmergencyPanel);
            $('navShare').addEventListener('click', toggleShareModal);

            // Extended navigation
            $('navStartFromMe').addEventListener('click', setMyLocationAsStart);
            $('navStart').addEventListener('click', startNavigation);
            $('navStop').addEventListener('click', stopNavigation);
            $('navClear').addEventListener('click', clearRoute);

            // Details modal
            $('detailsModal').addEventListener('click', (e) => {
                if (e.target === $('detailsModal')) {
                    closeDetails();
                }
            });

            // Share modal
            $('shareModal').addEventListener('click', (e) => {
                if (e.target === $('shareModal')) {
                    toggleShareModal();
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDetails();
                    $('sidebar').classList.remove('open');
                    $('routePanel').style.display = 'none';
                    $('navPanel').style.display = 'none';
                    $('downloadPanel').style.display = 'none';
                    $('weatherPanel').style.display = 'none';
                    $('emergencyPanel').style.display = 'none';
                    $('shareModal').style.display = 'none';
                }
            });

            // Swipe gestures for sidebar

            let startX, startY;
            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
            });
            document.addEventListener('touchmove', (e) => {
                if (!startX || !startY) return;
                const diffX = startX - e.touches[0].clientX;
                const diffY = startY - e.touches[0].clientY;

                // Check if we should handle the swipe
                const shouldHandleSwipe =
                    (startX < 50 && diffX < -100 && Math.abs(diffY) < 50) || // Open sidebar
                    (diffX > 100 && Math.abs(diffY) < 50); // Close sidebar

                if (shouldHandleSwipe) {
                    // Only prevent default if it's cancelable (won't cause warning)
                    if (e.cancelable) {
                        e.preventDefault();
                    }

                    // Handle the swipe action
                    toggleSidebar();
                    startX = null;
                    startY = null;
                }
            }, { passive: false }); // Important: Set passive to false to allow preventDefault
        } // <-- ADD THIS CLOSING BRACE - it closes the initializeEventListeners function

        // ===== START THE APP =====
        // Initialize the app when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>